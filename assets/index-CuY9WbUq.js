var p=r=>{throw TypeError(r)};var u=(r,t,e)=>t.has(r)||p("Cannot "+e);var y=(r,t,e)=>(u(r,t,"read from private field"),e?e.call(r):t.get(r)),m=(r,t,e)=>t.has(r)?p("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),l=(r,t,e,i)=>(u(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();var h;class x{constructor(){m(this,h);l(this,h,"none"),this.elementType="object",this.currentMode="create",this.shiftKey=!1,this.isEditing=!1,this.zoom=1,this.pan={x:0,y:0}}get getAction(){return y(this,h)}setAction(t){l(this,h,t),t==="edit"?this.isEditing=!0:t!=="none"&&(this.isEditing=!1,this.text=void 0,t!=="connect"&&(this.secondaryId=void 0))}clear(){this.setAction("none")}interpretClick(t,e,i,n=!1){switch(this.mousePosition={x:t,y:e},this.shiftKey=n,this.currentMode){case"create":this.setAction(i&&n?"delete":"create"),this.activeId=i;return;case"connect":{if(!i){this.activeId=void 0,this.setAction("select");return}const s=this.secondaryId!==i?this.secondaryId:this.activeId!==i?this.activeId:void 0;if(!s){this.setAction("select");break}this.secondaryId=s,this.setAction("connect");break}case"edit":this.setAction(i?"edit":"none");break;case"move":this.setAction(i?"select":"none");break}this.activeId=i??this.activeId}resetConnectionState(){this.secondaryId=void 0,this.currentMode==="connect"&&(this.activeId=void 0,this.setAction("none"))}interpretModeChange(t){this.currentMode=t,this.setAction("changeMode")}interpretDrag(t,e,i){if(this.currentMode!=="move"||!this.dragOffset)return;this.setAction("move");const n=e-this.dragOffset.x,s=i-this.dragOffset.y;this.secondaryId=t,this.mousePosition={x:n,y:s}}interpretMouseDown(t,e,i){this.text=void 0,this.mousePosition={x:t,y:e},this.secondaryId=i==null?void 0:i.id,i&&this.currentMode==="move"&&(this.dragOffset={x:t-i.x,y:e-i.y})}interpretMouseUp(){this.currentMode==="move"&&(this.dragOffset=void 0)}interpretDoubleClick(t,e,i){i&&(this.setAction("edit"),this.activeId=i,this.mousePosition={x:t,y:e})}interpretContextMenu(t,e,i){(i||this.activeId)&&this.setAction("menu"),i&&(this.activeId=i,this.mousePosition={x:t,y:e})}interpretContextMenuOption(t){if(this.activeId)switch(this.setAction(t),t){case"duplicate":this.setAction("create"),this.activeId=void 0;break;default:this.setAction(t)}}interpretControlsAction(t){switch(this.setAction(t),t){case"zoomIn":this.zoom*=1.2;break;case"zoomOut":this.zoom/=1.2;break;case"resetView":this.zoom=1,this.pan={x:0,y:0};break}}interpretTextEdit(t,e){this.setAction("edit"),this.activeId=t,this.text=e}interpretDelete(t){this.setAction("delete"),this.activeId=t}}h=new WeakMap;class S{constructor(t={}){this.velocities=new Map,this.isRunning=!1,this.animationId=void 0,this.animate=(e,i)=>{this.isRunning&&(this.step(e,i),this.animationId=requestAnimationFrame(()=>{this.animate(e,i)}))},this.config={repulsionForce:1e3,attractionForce:.1,damping:.9,minDistance:50,maxForce:10,iterations:1,springLength:100,...t}}start(t,e){this.isRunning||(this.isRunning=!0,this.initializeVelocities(t),this.animate(t,e))}stop(){this.isRunning=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=void 0)}step(t,e){if(t.length===0)return;const i=e.filter(n=>t.some(s=>s.id===n.from.id)&&t.some(s=>s.id===n.to.id));for(let n=0;n<this.config.iterations;n++)this.calculateForces(t,i),this.updatePositions(t)}initializeVelocities(t){this.velocities.clear(),t.forEach(e=>{this.velocities.set(e.id,{x:0,y:0})})}calculateForces(t,e){const i=new Map;t.forEach(n=>{i.set(n.id,{x:0,y:0})});for(let n=0;n<t.length;n++)for(let s=n+1;s<t.length;s++){const o=this.calculateRepulsionForce(t[n],t[s]),a=i.get(t[n].id),c=i.get(t[s].id);a.x+=o.x,a.y+=o.y,c.x-=o.x,c.y-=o.y}e.forEach(n=>{const s=i.get(n.from.id),o=i.get(n.to.id);if(s&&o){const a=this.calculateAttractionForce(n.from,n.to);s.x+=a.x,s.y+=a.y,o.x-=a.x,o.y-=a.y}}),t.forEach(n=>{const s=i.get(n.id),o=this.velocities.get(n.id),a=Math.sqrt(s.x*s.x+s.y*s.y);a>this.config.maxForce&&(s.x=s.x/a*this.config.maxForce,s.y=s.y/a*this.config.maxForce),o.x=(o.x+s.x)*this.config.damping,o.y=(o.y+s.y)*this.config.damping})}calculateRepulsionForce(t,e){const i=t.x-e.x,n=t.y-e.y,s=Math.sqrt(i*i+n*n);if(s<this.config.minDistance){const a=Math.atan2(n,i);return{x:Math.cos(a)*this.config.repulsionForce/this.config.minDistance,y:Math.sin(a)*this.config.repulsionForce/this.config.minDistance}}if(s===0)return{x:Math.random()*2-1,y:Math.random()*2-1};const o=this.config.repulsionForce/(s*s);return{x:i/s*o,y:n/s*o}}calculateAttractionForce(t,e){const i=e.x-t.x,n=e.y-t.y,s=Math.sqrt(i*i+n*n);if(s===0)return{x:0,y:0};const a=(s-this.config.springLength)*this.config.attractionForce;return{x:i/s*a,y:n/s*a}}updatePositions(t){t.forEach(e=>{const i=this.velocities.get(e.id);e.x=e.x+i.x,e.y=e.y+i.y,e.domElement&&(e.domElement.style.left=`${e.cornerX}px`,e.domElement.style.top=`${e.cornerY}px`)})}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}}class f{constructor(t,e){this.id=(Date.now()+Math.random()).toString(),this.from=t,this.to=e,t.connections.push(this),e.connections.push(this)}serialize(){return{id:this.id,from:this.from.id,to:this.to.id}}}class g{constructor(t,e,i,n=void 0){this.type=t,this.x=e,this.y=i,this.parent=n,this.id=(Date.now()+Math.random()).toString(),this.text=this.getDefaultText(),this.width=this.getDefaultWidth(),this.height=this.getDefaultHeight(),this.children=[],this.connections=[],n&&n.children.push(this)}get cornerX(){return this.x-this.width/2}get cornerY(){return this.y-this.height/2}getDefaultText(){return{collection:"Collection",function:"Function",object:"Object",input:"Input",output:"Output"}[this.type]||"AppElement"}getDefaultWidth(){return{collection:120,function:100,object:100,input:80,output:80}[this.type]||100}getDefaultHeight(){return{collection:80,function:60,object:80,input:40,output:40}[this.type]||60}serialize(){return{id:this.id,type:this.type,x:this.x,y:this.y,text:this.text,width:this.width,height:this.height,parentId:this.parent?this.parent.id:void 0,childIds:this.children.map(t=>t.id),connectionIds:this.connections.map(t=>t.id)}}}class E{constructor(t){this.appState=t}saveProject(){const t=this.appState.serialize(),e=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download="application_design.json",n.click(),URL.revokeObjectURL(i)}loadProject(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=e=>{var s;const n=(s=e.target.files)==null?void 0:s[0];if(n){const o=new FileReader;o.onload=a=>{var c;try{const d=(c=a.target)==null?void 0:c.result;typeof d=="string"&&(this.appState.deserialize(d),this.appState.rerenderNeeded=!0)}catch(d){alert("Error loading project: "+d.message)}},o.readAsText(n)}},t.click()}}class M{constructor(t,e){this.inputState=t,this.appState=e,this.projectManager=new E(e),this.layout=new S}processInput(){let t=this.inputState.activeId,e=this.inputState.secondaryId;switch(this.inputState.isEditing||(this.appState.editingElement=void 0),this.inputState.getAction){case"layout":this.appState.autoLayout=!this.appState.autoLayout,this.appState.autoLayout?this.restartLayout():this.layout.stop();break;case"create":this.appState.contextMenu=!1,t=this.handleCreate(),this.tryRestartLayout();break;case"move":this.handleMove(),this.tryRestartLayout();break;case"connect":this.handleConnect(),t=this.inputState.activeId,e=void 0,this.tryRestartLayout();break;case"select":t=this.handleSelect();break;case"delete":this.appState.contextMenu=!1,this.handleDelete(),this.tryRestartLayout();break;case"edit":this.appState.contextMenu=!1,this.handleEdit();break;case"menu":this.appState.contextMenu=!0,this.appState.targetPosition=this.inputState.mousePosition;break;case"save":this.projectManager.saveProject();break;case"load":this.projectManager.loadProject(),this.tryRestartLayout();break;case"clear":this.appState.clear(),this.layout.stop();break;case"zoomIn":case"zoomOut":case"resetView":this.appState.zoom=this.inputState.zoom,this.appState.pan=this.inputState.pan;break;case"changeMode":this.appState.currentMode=this.inputState.currentMode;break}this.appState.selectedElement=t?this.appState.getElementById(t):void 0,this.appState.fromElement=e?this.appState.getElementById(e):void 0,this.inputState.activeId=t,this.inputState.secondaryId=e}handleCreate(){if(!this.inputState.mousePosition)return;const{x:t,y:e}=this.inputState.mousePosition,i=this.inputState.activeId,n=i?this.appState.getElementById(i)??void 0:void 0,s=new g(this.inputState.elementType,t,e,n);return this.appState.addElement(s),this.inputState.activeId=s.id,s.id}handleMove(){if(this.inputState.secondaryId&&this.inputState.mousePosition){const t=this.appState.getElementById(this.inputState.secondaryId);t&&(t.x=this.inputState.mousePosition.x,t.y=this.inputState.mousePosition.y)}}handleConnect(){const t=this.appState.getElementById(this.inputState.secondaryId),e=this.appState.getElementById(this.inputState.activeId);if(!this.appState.connections.some(n=>n.from.id===t.id&&n.to.id===e.id||n.from.id===e.id&&n.to.id===t.id)){const n=new f(t,e);this.appState.addConnection(n)}}handleSelect(){return this.inputState.activeId}handleDelete(){const t=e=>{const i=this.appState.getElementById(e);i&&(i.children.forEach(n=>t(n.id)),this.appState.removeConnectionsFor(i.id),this.appState.removeElement(e))};this.inputState.activeId&&t(this.inputState.activeId)}handleEdit(){if(this.inputState.activeId){const t=this.appState.getElementById(this.inputState.activeId);this.appState.editingElement=t,this.inputState.text!==void 0&&t&&(t.text=this.inputState.text)}}restartLayout(){this.layout.stop(),this.layout.start(this.appState.elements,this.appState.connections)}tryRestartLayout(){this.appState.autoLayout&&this.restartLayout()}}class C{constructor(t){this.panelContainer=document.getElementById("editbar"),this.textInput=this._createInputField("Name"),this.idField=this._createReadOnlyProperty("ID"),this.typeField=this._createReadOnlyProperty("Type"),this.xField=this._createReadOnlyProperty("Pos X"),this.yField=this._createReadOnlyProperty("Pos Y"),this.updatePanel=e=>{if(!e){this.panelContainer.classList.add("hidden");return}this.panelContainer.classList.remove("hidden"),this.idField.textContent=e.id.toString(),this.typeField.textContent=e.type,this.textInput.value=e.text,this.xField.textContent=Math.round(e.x).toString(),this.yField.textContent=Math.round(e.y).toString()},this.appState=t}_createReadOnlyProperty(t){return this._createElement("readonlyPropTemplate","readonlyProps",".propValue",t)}_createInputField(t){const e=this._createElement("inputFieldTemplate","inputFields",".propInput",t);return e.name=t,e.autocomplete="off",e}_createElement(t,e,i,n){const s=document.getElementById(t).cloneNode(!0);return s.id="",s.querySelector(".propLabel").textContent=n,document.getElementById(e).appendChild(s),s.querySelector(i)}getInputs(){return[this.textInput]}}class I{constructor(t,e){this.canvas=t,this.state=e,this.elementMap=new Map,this.connectionMap=new Map,this.propertiesPanel=new C(e)}render(){var t;this.updateStatus(),this.updateElementTypeSelection(),this.setCanvasTransform(this.state.zoom,this.state.pan.x,this.state.pan.y),this.renderElements(this.state.elements,((t=this.state.selectedElement)==null?void 0:t.id)??void 0),this.renderConnections(this.state.connections),this.propertiesPanel.updatePanel(this.state.selectedElement),this.state.rerenderNeeded=!1}renderElements(t,e){const i=new Set(t.map(s=>s.id));for(const[s,o]of this.elementMap)i.has(s)||(o.remove(),this.elementMap.delete(s));t.forEach(s=>{var d;let o=this.elementMap.get(s.id);o||(o=this.createElementDOM(s),this.elementMap.set(s.id,o));const a=s.id===e,c=((d=this.state.editingElement)==null?void 0:d.id)===s.id;this.updateElementDOM(o,s),a?o.classList.add("selected"):o.classList.remove("selected"),this.updateEditingState(o,s,c)});const n=this.state.targetPosition;this.state.contextMenu&&n?this.showContextMenu(n.x,n.y):this.hideContextMenu()}createElementDOM(t){const e=document.createElement("div");e.className=`element ${t.type}`,e.dataset.id=t.id;const i=document.createElement("span");i.className="element-text",e.appendChild(i);const n=document.createElement("input");return n.className="element-input",n.type="text",n.style.display="none",n.style.background="transparent",n.style.border="none",n.style.outline="none",n.style.color="inherit",n.style.font="inherit",n.style.textAlign="center",n.style.width="100%",e.appendChild(n),this.updateElementDOM(e,t),this.canvas.appendChild(e),e}updateElementDOM(t,e){t.style.left=e.x-e.width/2+"px",t.style.top=e.y-e.height/2+"px",t.style.width=e.width+"px",t.style.height=e.height+"px";const i=t.querySelector(".element-text"),n=t.querySelector(".element-input");i&&(i.textContent=e.text),n&&(n.value=e.text)}updateEditingState(t,e,i){const n=t.querySelector(".element-text"),s=t.querySelector(".element-input");n&&s&&(i?(n.style.display="none",s.style.display="block",s.focus(),s.value=e.text):(n.style.display="block",s.style.display="none",n.textContent=e.text))}renderConnections(t){const e=new Set(t.map(i=>i.id));for(const[i,n]of this.connectionMap)e.has(i)||(n.remove(),this.connectionMap.delete(i));t.forEach(i=>{const n=i.from,s=i.to;if(!n||!s)return;let o=this.connectionMap.get(i.id);o?this.updateConnectionDOM(o,n,s):(o=this.createConnectionDOM(n,s),this.connectionMap.set(i.id,o))})}createConnectionDOM(t,e){const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.classList.add("connection-svg"),i.style.position="absolute",i.style.pointerEvents="none",i.style.zIndex="1";const n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.classList.add("connection-line"),n.setAttribute("stroke","rgba(255, 255, 255, 0.8)"),n.setAttribute("stroke-width","2"),i.appendChild(n),this.canvas.appendChild(i),this.updateConnectionDOM(i,t,e),i}updateConnectionDOM(t,e,i){const n=t.querySelector("line");if(!n)return;const s=Math.min(e.x,i.x)-20,o=Math.min(e.y,i.y)-20,a=Math.max(e.x,i.x)+20,c=Math.max(e.y,i.y)+20;t.style.left=s+"px",t.style.top=o+"px",t.style.width=a-s+"px",t.style.height=c-o+"px",n.setAttribute("x1",(e.x-s).toString()),n.setAttribute("y1",(e.y-o).toString()),n.setAttribute("x2",(i.x-s).toString()),n.setAttribute("y2",(i.y-o).toString())}showContextMenu(t,e){const i=document.getElementById("contextMenu"),n=this.canvas.getBoundingClientRect();i&&(i.style.left=n.left+t+"px",i.style.top=n.top+e+"px",i.classList.remove("hidden"))}hideContextMenu(){const t=document.getElementById("contextMenu");t&&t.classList.add("hidden")}getActivePanelInputs(){return this.propertiesPanel.getInputs()}updateElementTypeSelection(){const t=document.getElementById("elementTypeSelection");this.state.currentMode==="create"?t.classList.remove("hidden"):t.classList.add("hidden")}updateStatus(){const t={create:"Create/Child Mode",connect:"Connection Mode",move:"Movement Mode",edit:"Edit Mode"},e={collection:"Collections",function:"Functions",object:"Objects",input:"Inputs",output:"Outputs"};let i=`${t[this.state.currentMode]}`;this.state.currentMode==="create"&&(i+=` - ${e[this.state.currentElementType]}`),this.state.currentMode==="connect"&&this.state.fromElement&&(i+=" - Select target element");const n=document.getElementById("status");n&&(n.textContent=i)}setCanvasTransform(t,e,i){this.canvas.style.transform=`scale(${t}) translate(${e}px, ${i}px)`}}class L{constructor(t,e,i,n){this.canvas=t,this.inputState=e,this.getElementsCallback=i,this.getPanelInputsCallback=n,this.handleClick=s=>{const o=this.getElementsCallback(),{x:a,y:c}=this.getCanvasCoordinates(s),d=this.findElementAt(o,a,c);this.inputState.interpretClick(a,c,d==null?void 0:d.id,s.shiftKey)},this.handleMouseDown=s=>{const{x:o,y:a}=this.getCanvasCoordinates(s),c=this.findElementAt(this.getElementsCallback(),o,a);this.inputState.interpretMouseDown(o,a,c)},this.handleMouseUp=()=>{this.inputState.interpretMouseUp()},this.handleMouseMove=s=>{const{x:o,y:a}=this.getCanvasCoordinates(s);this.inputState.secondaryId&&this.inputState.currentMode==="move"&&(this.getElementsCallback().find(v=>v.id===this.inputState.secondaryId)&&this.inputState.dragOffset&&this.inputState.interpretDrag(this.inputState.secondaryId,o,a),s.preventDefault())},this.handleDoubleClick=s=>{const{x:o,y:a}=this.getCanvasCoordinates(s),c=this.getElementsCallback(),d=this.findElementAt(c,o,a);d&&this.inputState.interpretDoubleClick(o,a,d.id)},this.handleContextMenu=s=>{s.preventDefault();const{x:o,y:a}=this.getCanvasCoordinates(s),c=this.findElementAt(this.getElementsCallback(),o,a);this.inputState.interpretContextMenu(o,a,c==null?void 0:c.id)},this.handleContextMenuOption=(s,o)=>{s.preventDefault(),this.inputState.interpretContextMenuOption(o)},this.handleControlsAction=(s,o)=>{s.preventDefault(),this.inputState.interpretControlsAction(o)},this.handleDirectAction=(s,o)=>{s.preventDefault(),this.inputState.setAction(o)},this.handleInput=s=>{const o=s.target;if(!o||o.tagName!=="INPUT")return;const a=this.inputState.activeId;if(!a)return;const c=o.closest(".element");if((c==null?void 0:c.dataset.id)===a&&this.inputState.isEditing){this.inputState.interpretTextEdit(a,o.value);return}this.getPanelInputsCallback().includes(o)&&a&&this.inputState.interpretTextEdit(a,o.value)},this.handleKeyDown=s=>{const o=this.inputState.activeId;if(o&&s.key==="F2"){this.inputState.interpretTextEdit(o);return}this.inputState.isEditing&&o&&(s.key==="Escape"||s.key==="Enter")&&(this.inputState.setAction("select"),s.preventDefault())},this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("click",this.handleClick),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("dblclick",this.handleDoubleClick),this.setupModeButtons(),this.setupElementTypeButtons(),this.setupContextMenuEvents(),this.setupProjectEvents(),this.setupControlsEvents(),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("input",this.handleInput)}setupControlsEvents(){const t=document.getElementById("layoutBtn"),e=document.getElementById("zoomInBtn"),i=document.getElementById("zoomOutBtn"),n=document.getElementById("resetViewBtn");t.addEventListener("click",s=>{this.handleControlsAction(s,"layout"),t.classList.toggle("active")}),e.addEventListener("click",s=>this.handleControlsAction(s,"zoomIn")),i.addEventListener("click",s=>this.handleControlsAction(s,"zoomOut")),n.addEventListener("click",s=>this.handleControlsAction(s,"resetView"))}setupProjectEvents(){const t=document.getElementById("saveBtn"),e=document.getElementById("loadBtn"),i=document.getElementById("clearBtn");t&&t.addEventListener("click",n=>this.handleDirectAction(n,"save")),e&&e.addEventListener("click",n=>this.handleDirectAction(n,"load")),i&&i.addEventListener("click",n=>this.handleDirectAction(n,"clear"))}setupModeButtons(){document.querySelectorAll(".mode-btn, [data-mode]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".mode-btn, [data-mode]").forEach(i=>i.classList.remove("active")),t.classList.add("active");const e=t.dataset.mode;e&&this.inputState.interpretModeChange(e)})})}setupElementTypeButtons(){document.querySelectorAll(".element-btn, [data-type]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".element-btn, [data-type]").forEach(i=>i.classList.remove("active")),t.classList.add("active");const e=t.dataset.type;e&&(this.inputState.elementType=e)})})}setupContextMenuEvents(){var t,e,i;(t=document.getElementById("editBtn"))==null||t.addEventListener("click",n=>this.handleContextMenuOption(n,"edit")),(e=document.getElementById("duplicateBtn"))==null||e.addEventListener("click",n=>this.handleContextMenuOption(n,"duplicate")),(i=document.getElementById("deleteBtn"))==null||i.addEventListener("click",n=>this.handleContextMenuOption(n,"delete")),this.canvas.addEventListener("contextmenu",this.handleContextMenu)}getCanvasCoordinates(t){const e=this.canvas.getBoundingClientRect(),i=this.inputState.zoom,n=this.inputState.pan,s=(t.clientX-e.left)/i-n.x,o=(t.clientY-e.top)/i-n.y;return{x:s,y:o}}resetConnectionState(){this.inputState.resetConnectionState()}handleDeleteConfirmed(t){this.inputState.interpretDelete(t)}findElementAt(t,e,i){for(let n=t.length-1;n>=0;n--){const s=t[n],o=s.x-s.width/2,a=s.x+s.width/2,c=s.y-s.height/2,d=s.y+s.height/2;if(e>=o&&e<=a&&i>=c&&i<=d)return s}}}class w{constructor(){this.currentMode="create",this.currentElementType="object",this.elements=[],this.connections=[],this.dragging=!1,this.zoom=1,this.pan={x:0,y:0},this.contextMenu=!1,this.rerenderNeeded=!1,this.autoLayout=!0}setMode(t){this.currentMode=t}setElementType(t){this.currentElementType=t}addElement(t){this.elements.push(t)}removeElement(t){const e=this.elements.findIndex(i=>i.id===t);e!==-1&&this.elements.splice(e,1)}addConnection(t){this.connections.push(t)}removeConnection(t){const e=this.connections.findIndex(i=>i.id===t);e!==-1&&this.connections.splice(e,1)}removeConnectionsFor(t){this.connections=this.connections.filter(e=>e.from.id!==t&&e.to.id!==t)}getElementById(t){return this.elements.find(e=>e.id===t)}selectElement(t){var e;(e=this.selectedElement)!=null&&e.domElement&&this.selectedElement.domElement.classList.remove("selected"),this.selectedElement=t,t!=null&&t.domElement&&t.domElement.classList.add("selected")}hasConnection(t,e){return this.connections.some(i=>i.from.id===t&&i.to.id===e||i.from.id===e&&i.to.id===t)}serialize(){return JSON.stringify({elements:this.elements.map(t=>t.serialize()),connections:this.connections.map(t=>t.serialize())})}deserialize(t){const e=JSON.parse(t);this.clear(),this.elements=e.elements.map(i=>{const n=new g(i.type,i.x,i.y,i.parent);return n.id=i.id,n.width=i.width,n.height=i.height,n}),this.connections=e.connections.map(i=>{const n=this.getElementById(i.from.id),s=this.getElementById(i.to.id);if(!n||!s)throw new Error("Invalid connection: missing element");return new f(n,s)})}clear(){this.elements=[],this.connections=[],this.selectedElement=void 0,this.dragging=!1,this.fromElement=void 0,this.zoom=1,this.pan={x:0,y:0},this.editingElement=void 0,this.contextMenu=!1,this.targetPosition=void 0}}class A{constructor(t){this.appState=new w,this.inputState=new x,this.logicLayer=new M(this.inputState,this.appState),this.renderLayer=new I(t,this.appState),this.inputLayer=new L(t,this.inputState,()=>this.appState.elements,()=>this.renderLayer.getActivePanelInputs()),this.setupAsyncHandlers(),this.start()}setupAsyncHandlers(){this.inputLayer.handleDeleteConfirmed=t=>{this.inputState.interpretDelete(t)}}start(){const t=()=>{try{(this.inputState.getAction!=="none"||this.appState.rerenderNeeded||this.appState.autoLayout)&&(this.logicLayer.processInput(),this.renderLayer.render(),this.inputState.clear())}catch(e){console.error("Error in update cycle:",e)}requestAnimationFrame(t)};requestAnimationFrame(t)}save(){return this.appState.serialize()}load(t){try{this.appState.deserialize(t),this.renderLayer.render()}catch(e){console.error("Failed to load data:",e)}}exportModel(){return this.appState.serialize()}importModel(t){this.appState.deserialize(JSON.stringify(t)),this.renderLayer.render()}}document.addEventListener("DOMContentLoaded",()=>{try{const r=document.getElementById("canvas"),t=new A(r);window.app=t}catch(r){console.error("Failed to initialize application:",r)}});
