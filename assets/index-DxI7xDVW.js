var K=h=>{throw TypeError(h)};var U=(h,t,e)=>t.has(h)||K("Cannot "+e);var D=(h,t,e)=>(U(h,t,"read from private field"),e?e.call(h):t.get(h)),X=(h,t,e)=>t.has(h)?K("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e),P=(h,t,e,i)=>(U(h,t,"write to private field"),i?i.call(h,e):t.set(h,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();var w;class G{constructor(){X(this,w);P(this,w,"none"),this.elementType="object",this.currentMode="create",this.shiftKey=!1,this.isEditing=!1,this.zoom=1,this.pan={x:0,y:0}}get action(){return D(this,w)}updateActiveId(t){this.activeId&&this.activeId!==t&&(this.secondaryId=this.activeId),this.activeId=t}executeAction(t,e){switch(P(this,w,this.validateAction(t)),D(this,w)){case"edit":this.text=e,this.isEditing=!0;return;case"connect":return;case"zoomIn":this.zoom*=1.2;return;case"zoomOut":this.zoom/=1.2;return;case"zoomReset":this.zoom=1,this.pan={x:0,y:0};return}this.isEditing=!1,this.text=void 0,this.secondaryId=void 0}onMouseDown(t,e,i){this.mousePosition={x:t,y:e},this.updateActiveId(i==null?void 0:i.id),i!=null&&i.id&&this.currentMode==="move"&&(this.dragOffset={x:t-i.x,y:e-i.y})}onMouseUp(){this.dragOffset=void 0}onClick(t,e,i){this.mousePosition={x:t,y:e},this.updateActiveId(i),this.executeAction(this.currentMode)}onDoubleClick(t,e,i){i&&(this.mousePosition={x:t,y:e},this.activeId=i,this.executeAction("edit"))}onDrag(t,e,i){this.currentMode==="move"&&this.dragOffset&&(this.activeId=t,this.mousePosition={x:e-this.dragOffset.x,y:i-this.dragOffset.y},this.executeAction("move"))}onContextMenu(t,e,i){i&&(this.mousePosition={x:t,y:e},this.activeId=i,this.executeAction("menu"))}setMode(t){this.currentMode=t,this.executeAction("mode")}setElementType(t){this.elementType=t,this.executeAction("select")}validateAction(t){switch(t){case"connect":return!this.activeId||!this.secondaryId||this.activeId===this.secondaryId?"select":this.shiftKey?"disconnect":"connect";case"duplicate":return this.activeId=void 0,"create";default:return t}}clear(){P(this,w,"none")}}w=new WeakMap;const O=125;class W{constructor(t,e={}){this.canvasElement=t,this.velocities=new Map,this.forces=new Map,this.connectionMap=new Map,this.isRunning=!1,this.temperature=1,this.lastInteractionTime=Date.now(),this.coolingStartTime=0,this.ignoreElementIds=[],this.animate=(i,n)=>{if(!this.isRunning)return;const s=this.step(i),a=this.config.stopThreshold*(.1+this.temperature*.9);if(s<a&&this.temperature<=this.config.minTemperature){this.stop();return}this.animationId=requestAnimationFrame(()=>this.animate(i,n))},this.config={repulsionForce:2e3,attractionForce:.5,damping:.5,minDistance:O,maxForce:10,iterations:1,springLength:O,movementThreshold:.1,stopThreshold:.05,gridForce:.08,centerAttractionForce:.01,gridSize:O/2,spatialHashSize:300,maxRepulsionDistance:250,connectionGridAlignForce:.1,gridRepulsionFactor:.5,perfectAlignmentThreshold:5,annealingRate:.8,minTemperature:.05,coolingDelay:2e3,reheatOnInteraction:!0,childScaleFactor:.7,childCenterStrength:.15,...e}}setCanvasElement(t){this.canvasElement=t}getCanvasCenter(){return this.canvasElement?{x:this.canvasElement.offsetWidth/2,y:this.canvasElement.offsetHeight/2}:{x:0,y:0}}updateTemperature(){const t=Date.now();t-this.lastInteractionTime<this.config.coolingDelay||(this.coolingStartTime===0&&(this.coolingStartTime=t),this.temperature>this.config.minTemperature&&(this.temperature*=this.config.annealingRate,this.temperature=Math.max(this.temperature,this.config.minTemperature)))}getAllElements(t){const e=[],i=n=>{n.forEach(s=>{e.push(s),s.children&&s.children.length>0&&i(s.children)})};return i(t),e}initializeElementState(t){this.getAllElements(t).forEach(i=>{this.velocities.has(i.id)||this.velocities.set(i.id,{x:0,y:0}),this.forces.has(i.id)||this.forces.set(i.id,{x:0,y:0})})}buildConnectionMap(t){this.connectionMap.clear(),t.forEach(e=>{e.from.depth===e.to.depth&&(this.connectionMap.has(e.from.id)||this.connectionMap.set(e.from.id,[]),this.connectionMap.has(e.to.id)||this.connectionMap.set(e.to.id,[]),this.connectionMap.get(e.from.id).push(e.to),this.connectionMap.get(e.to.id).push(e.from))})}start(t,e,i){this.ignoreElementIds=i,!this.isRunning&&(this.isRunning=!0,this.velocities.clear(),this.forces.clear(),this.initializeElementState(t),this.buildConnectionMap(e),this.temperature=1,this.lastInteractionTime=Date.now(),this.coolingStartTime=0,this.animate(t,e))}stop(){this.isRunning=!1,this.animationId&&cancelAnimationFrame(this.animationId)}step(t){if(!t.length)return 0;this.updateTemperature();let e=0;for(let i=0;i<this.config.iterations;i++)e+=this.calculateForcesHierarchical(t,{center:this.getCanvasCenter(),depth:0}),e+=this.updatePositionsHierarchical(t);return e}calculateForcesHierarchical(t,e){let i=0;return i+=this.calculateForcesForLevel(t,e),t.forEach(n=>{if(n.children&&n.children.length>0){const s={center:{x:n.x,y:n.y},depth:e.depth+1,parentElement:n};i+=this.calculateForcesHierarchical(n.children,s)}}),i}calculateForcesForLevel(t,e){const{center:i,depth:n}=e,s=Math.pow(this.config.childScaleFactor,n),a=new Map,r=this.config.spatialHashSize*s;return t.forEach(o=>{const c=`${Math.floor(o.x/r)},${Math.floor(o.y/r)}`,l=a.get(c)||[];a.has(c)||a.set(c,l),l.push(o)}),t.forEach(o=>{const c=this.forces.get(o.id);c.x=c.y=0}),t.forEach(o=>{var q;if(o.isAnchored)return;const c=this.forces.get(o.id),l=Math.floor(o.x/r),d=Math.floor(o.y/r);for(let p=-1;p<=1;p++)for(let x=-1;x<=1;x++){const I=a.get(`${l+p},${d+x}`);I&&I.forEach(y=>{if(o.id===y.id||this.ignoreElementIds.includes(y.id))return;const C=o.x-y.x,M=o.y-y.y,S=C*C+M*M,L=this.config.maxRepulsionDistance*s;if(S>L**2)return;if(S===0){c.x+=(Math.random()-.5)*this.temperature*s,c.y+=(Math.random()-.5)*this.temperature*s;return}const v=Math.sqrt(S),m=this.config.minDistance*s;let E=this.config.repulsionForce*s/S*this.temperature;v<m&&(E+=(m-v)*this.config.repulsionForce*s*.01*this.temperature);const g=this.config.gridSize*s,_=Math.abs(C%g)<5*s||Math.abs(C%g)>g-5*s,H=Math.abs(M%g)<5*s||Math.abs(M%g)>g-5*s;(_||H)&&(E*=this.config.gridRepulsionFactor),c.x+=C/v*E,c.y+=M/v*E})}(q=this.connectionMap.get(o.id))==null||q.forEach(p=>{if(o.depth!==p.depth)return;const x=p.x-o.x,I=p.y-o.y,y=Math.sqrt(x*x+I*I);if(y===0)return;const C=this.config.springLength*s,M=(y-C)*this.config.attractionForce*s*this.temperature;c.x+=x/y*M,c.y+=I/y*M;const S=Math.atan2(I,x),L=10*Math.PI/180,v=this.config.connectionGridAlignForce*s*this.temperature,m=this.config.gridSize*s;if(Math.abs(S)<L||Math.abs(S-Math.PI)<L){const E=Math.round(o.y/m)*m;c.y+=(E-o.y)*v;const g=Math.round(p.y/m)*m;this.forces.get(p.id).y+=(g-p.y)*v}else if(Math.abs(S-Math.PI/2)<L||Math.abs(S+Math.PI/2)<L){const E=Math.round(o.x/m)*m;c.x+=(E-o.x)*v;const g=Math.round(p.x/m)*m;this.forces.get(p.id).x+=(g-p.x)*v}});const u=this.config.gridSize*s,A=Math.round(o.x/u)*u,R=Math.round(o.y/u)*u,f=Math.max(.3,this.temperature);c.x+=(A-o.x)*this.config.gridForce*s*f,c.y+=(R-o.y)*this.config.gridForce*s*f;const T=n===0?this.config.centerAttractionForce:this.config.childCenterStrength;c.x+=(i.x-o.x)*T*s*this.temperature,c.y+=(i.y-o.y)*T*s*this.temperature;const F=this.config.maxForce*s*Math.max(.1,this.temperature),k=Math.sqrt(c.x*c.x+c.y*c.y);k>F&&(c.x=c.x/k*F,c.y=c.y/k*F);const $=this.config.damping*(.3+this.temperature*.7),B=this.velocities.get(o.id);B.x=(B.x+c.x)*$,B.y=(B.y+c.y)*$}),0}updatePositionsHierarchical(t){let e=0;return e+=this.updatePositionsForLevel(t,0),t.forEach(i=>{i.children&&i.children.length>0&&(e+=this.updatePositionsHierarchical(i.children))}),e}updatePositionsForLevel(t,e){let i=0;const n=Math.pow(this.config.childScaleFactor,e);return t.forEach(s=>{if(s.isAnchored||this.ignoreElementIds.includes(s.id))return;const a=this.velocities.get(s.id),r=Math.sqrt(a.x*a.x+a.y*a.y),o=this.config.movementThreshold*n*this.temperature;r>o&&(s.x+=a.x,s.y+=a.y,i+=r);const c=this.config.gridSize*n,l=s.x%c,d=s.y%c,u=this.config.perfectAlignmentThreshold*n*(2-this.temperature),A=Math.abs(l)<u||Math.abs(l-c)<u||Math.abs(l+c)<u,R=Math.abs(d)<u||Math.abs(d-c)<u||Math.abs(d+c)<u;if(A){const f=Math.round(s.x/c)*c;Math.abs(f-s.x)>.01&&(i+=Math.abs(f-s.x),s.x=f)}if(R){const f=Math.round(s.y/c)*c;Math.abs(f-s.y)>.01&&(i+=Math.abs(f-s.y),s.y=f)}}),i}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}reheatSimulation(){this.config.reheatOnInteraction&&(this.temperature=1,this.lastInteractionTime=Date.now(),this.coolingStartTime=0)}}class Y{constructor(t,e){this.id=(Date.now()+Math.random()).toString(),this.from=t,this.to=e,t.connections.push(this),e.connections.push(this)}serialize(){return{id:this.id,from:this.from.id,to:this.to.id}}}const b=class b{constructor(t,e,i,n=void 0,s=!1){this.type=t,this.x=e,this.y=i,this.parent=n,this.strokeWidth=15,this.depth=0,this.id=(Date.now()+Math.random()).toString(),this.text=this.getDefaultText(),this.children=[],this.connections=[],this.isAnchored=s;const{widthRatio:a,heightRatio:r}=this.getDefaultRatios();this.widthRatio=a,this.heightRatio=r,this.size=b.BASE_SIZE_UNIT,this.calculateSize(),n&&(this.depth=n.depth+1,n.children.push(this),n.calculateSize())}get width(){return this.size*this.widthRatio}get height(){return this.size*this.heightRatio}calculateSize(){var i;if(this.children.length===0)this.size=b.BASE_SIZE_UNIT;else{const n=this.children.reduce((r,o)=>r+o.width*o.height,0),s=this.widthRatio*this.heightRatio||1,a=Math.sqrt(n/s)*1.3;this.size=Math.max(a,b.BASE_SIZE_UNIT)}const t=this.widthRatio/this.heightRatio,e=b.BASE_SIZE_UNIT/this.size;this.strokeWidth=15*Math.pow(e,.4)*Math.sqrt(t),(i=this.parent)==null||i.calculateSize()}getDefaultText(){return{collection:"Collection",function:"Function",object:"Object",input:"Input",output:"Output"}[this.type]||"AppElement"}getDefaultRatios(){return{collection:{widthRatio:1,heightRatio:1},function:{widthRatio:1.2,heightRatio:.8},object:{widthRatio:1,heightRatio:.8},input:{widthRatio:.8,heightRatio:.5},output:{widthRatio:.8,heightRatio:.5}}[this.type]||{widthRatio:1,heightRatio:1}}serialize(){return{id:this.id,type:this.type,x:this.x,y:this.y,text:this.text,parentId:this.parent?this.parent.id:void 0,childIds:this.children.map(t=>t.id),connectionIds:this.connections.map(t=>t.id),isAnchored:this.isAnchored}}};b.BASE_SIZE_UNIT=75;let z=b;class Z{constructor(t){this.appState=t}saveProject(){const t=this.appState.serialize(),e=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download="application_design.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}loadProject(){return new Promise((t,e)=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=n=>{var r;const a=(r=n.target.files)==null?void 0:r[0];if(a){const o=new FileReader;o.onload=c=>{var l;try{const d=(l=c.target)==null?void 0:l.result;typeof d=="string"?(this.appState.deserialize(d),this.appState.rerenderNeeded=!0,t()):e(new Error("Failed to read file as text"))}catch(d){const u=d instanceof Error?d.message:"Unknown error";alert("Error loading project: "+u),e(d)}},o.onerror=()=>{const c=new Error("Failed to read file");alert("Error reading file"),e(c)},o.readAsText(a)}else e(new Error("No file selected"))},i.oncancel=()=>{t()},document.body.appendChild(i),i.click(),document.body.removeChild(i)})}}class J{constructor(){this.popup=null,this.hideTimeout=null,this.popup=document.getElementById("popup")}show(t){if(!this.popup)return;const e=this.popup.querySelector(".message"),i=this.popup.querySelector(".description");e&&(e.textContent="Rule: "+(t.message||"Action not allowed")),i&&(i.textContent=t.ruleName),this.popup.classList.remove("hide"),this.popup.offsetWidth,this.popup.classList.add("show"),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>{this.hide()},5e3)}hide(){this.popup&&this.popup.classList.contains("show")&&(this.popup.classList.remove("show"),this.popup.offsetWidth,this.popup.classList.add("hide"))}}class Q{constructor(){this.rules=[],this.registerRule(new V),this.registerRule(new tt),this.registerRule(new et),this.registerRule(new it)}registerRule(t){this.rules.push(t)}evaluateConnection(t,e,i){const n={appState:i,fromElement:t,toElement:e};return this.rules.map(s=>s.evaluate(n))}evaluateElementCreation(t,e){const i={appState:e,element:t};return this.rules.map(n=>n.evaluate(i))}getBlockingResult(t){return t.find(e=>!e.allowed)||null}}class V{constructor(){this.name="Type Match",this.description="Outputs can only connect to compatible Inputs"}evaluate(t){const{fromElement:e,toElement:i}=t;return!e||!i?{allowed:!0,ruleName:this.name}:e.type==="output"&&i.type==="input"?{allowed:!0,ruleName:this.name}:{allowed:!0,ruleName:this.name}}}class tt{constructor(){this.name="No Loops",this.description="Prevents circular connections that would create loops"}evaluate(t){const{fromElement:e,toElement:i,appState:n}=t;return!e||!i||!n?{allowed:!0,ruleName:this.name}:this.wouldCreateCycle(e,i,n)?{allowed:!1,message:`Cannot connect ${e.text||e.type} to ${i.text||i.type}: would create a loop`,ruleName:this.name}:{allowed:!0,ruleName:this.name}}wouldCreateCycle(t,e,i){const n=new Set,s=(a,r)=>{if(a.id===r.id)return!0;if(n.has(a.id))return!1;n.add(a.id);const o=i.connections.filter(c=>c.from.id===a.id);for(const c of o)if(s(c.to,r))return!0;return!1};return s(e,t)}}class et{constructor(){this.name="I/O Compatibility",this.description="Prevents incompatible input/output connections"}evaluate(t){const{fromElement:e,toElement:i}=t;return!e||!i?{allowed:!0,ruleName:this.name}:e.type==="input"&&i.type==="input"?{allowed:!1,message:`Cannot connect Input to Input: ${e.text||"Input"} → ${i.text||"Input"}`,ruleName:this.name}:e.type==="output"&&i.type==="output"?{allowed:!1,message:`Cannot connect Output to Output: ${e.text||"Output"} → ${i.text||"Output"}`,ruleName:this.name}:{allowed:!0,ruleName:this.name}}}class it{constructor(){this.name="Depth Matching",this.description="Connections should be between elements at compatible nesting levels"}evaluate(t){const{fromElement:e,toElement:i}=t;if(!e||!i)return{allowed:!0,ruleName:this.name};const n=this.getElementDepth(e),s=this.getElementDepth(i);return Math.abs(n-s)>1?{allowed:!1,message:`Cannot connect elements with depth difference > 1: ${e.text||e.type} (depth ${n}) → ${i.text||i.type} (depth ${s})`,ruleName:this.name}:{allowed:!0,ruleName:this.name}}getElementDepth(t){let e=0,i=t.parent;for(;i;)e++,i=i.parent;return e}}class st{constructor(t,e,i){this.inputState=t,this.appState=e,this.projectManager=new Z(e),this.layout=new W(i),this.ruleEngine=new Q,this.ruleFeedback=new J}processInput(){let t=this.inputState.activeId,e=this.inputState.secondaryId;switch(this.inputState.isEditing||(this.appState.editingElement=void 0),this.inputState.action){case"layout":this.appState.layout=!this.appState.layout,this.appState.layout?this.restartLayout():this.layout.stop();break;case"create":this.appState.contextMenu=!1,t=this.handleCreate(),this.tryRestartLayout();break;case"move":this.handleMove(),this.tryRestartLayout();break;case"connect":this.handleConnect(),t=this.inputState.activeId,e=void 0,this.tryRestartLayout();break;case"disconnect":break;case"details":this.appState.details=!this.appState.details;break;case"select":this.ruleFeedback.hide(),t=this.handleSelect(),this.tryRestartLayout();break;case"anchor":this.handleAnchor();break;case"delete":this.appState.contextMenu=!1,this.handleDelete(),this.tryRestartLayout(),t=void 0;break;case"edit":this.appState.contextMenu=!1,this.handleEdit();break;case"menu":this.appState.contextMenu=!0,this.appState.targetPosition=this.inputState.mousePosition;break;case"export":this.projectManager.saveProject();break;case"import":this.projectManager.loadProject(),this.tryRestartLayout();break;case"clear":this.appState.clear(),this.layout.stop();break;case"zoomIn":case"zoomOut":case"zoomReset":this.appState.zoom=this.inputState.zoom,this.appState.pan=this.inputState.pan;break;case"mode":this.appState.currentMode=this.inputState.currentMode;break}this.appState.selectedElement=t?this.appState.getElementById(t):void 0,this.appState.fromElement=e?this.appState.getElementById(e):void 0,this.inputState.activeId=t,this.inputState.secondaryId=e,this.appState.currentMode=this.inputState.currentMode,this.appState.elementType=this.inputState.elementType}handleCreate(){if(!this.inputState.mousePosition)return;const{x:t,y:e}=this.inputState.mousePosition,i=this.inputState.activeId,n=i?this.appState.getElementById(i)??void 0:void 0,s=new z(this.inputState.elementType,t,e,n),a=this.ruleEngine.evaluateElementCreation(s,this.appState),r=this.ruleEngine.getBlockingResult(a);if(r){this.ruleFeedback.show(r);return}return this.appState.addElement(s),this.inputState.activeId=s.id,s.id}handleMove(){if(this.inputState.activeId&&this.inputState.mousePosition){const t=this.appState.getElementById(this.inputState.activeId);t&&(t.x=this.inputState.mousePosition.x,t.y=this.inputState.mousePosition.y)}}handleConnect(){const t=this.appState.getElementById(this.inputState.secondaryId),e=this.appState.getElementById(this.inputState.activeId);if(this.appState.connections.some(r=>r.from.id===t.id&&r.to.id===e.id||r.from.id===e.id&&r.to.id===t.id)){this.ruleFeedback.show({allowed:!1,message:`Connection already exists between ${t.text||t.type} and ${e.text||e.type}`,ruleName:"Duplicate Connection"});return}const n=this.ruleEngine.evaluateConnection(t,e,this.appState),s=this.ruleEngine.getBlockingResult(n);if(s){this.ruleFeedback.show(s);return}const a=new Y(t,e);this.appState.addConnection(a)}handleSelect(){return this.inputState.activeId}handleAnchor(){const t=this.appState.getElementById(this.inputState.activeId);t.isAnchored=!t.isAnchored}handleDelete(){const t=e=>{const i=this.appState.getElementById(e);i&&(i.children.forEach(n=>t(n.id)),this.appState.removeConnectionsFor(i.id),this.appState.removeElement(e))};this.inputState.activeId&&t(this.inputState.activeId)}handleEdit(){if(this.inputState.activeId){const t=this.appState.getElementById(this.inputState.activeId);this.appState.editingElement=t,this.inputState.text!==void 0&&t&&(t.text=this.inputState.text)}}restartLayout(){this.layout.stop();const t=this.inputState.secondaryId?[this.inputState.secondaryId]:[];this.layout.start(this.appState.getRootElements(),this.appState.connections,t)}tryRestartLayout(){this.appState.layout&&this.restartLayout()}}class nt{constructor(){this.panelContainer=document.getElementById("rightBar"),this.textInput=this._createInputField("Name"),this.idField=this._createReadOnlyProperty("ID"),this.typeField=this._createReadOnlyProperty("Type"),this.xField=this._createReadOnlyProperty("Pos X"),this.yField=this._createReadOnlyProperty("Pos Y"),this.updatePanel=t=>{if(!t){this.panelContainer.classList.add("hid");return}this.panelContainer.classList.remove("hid"),this.idField.textContent=t.id.toString(),this.typeField.textContent=t.type,this.textInput.value=t.text,this.xField.textContent=Math.round(t.x).toString(),this.yField.textContent=Math.round(t.y).toString()}}_createReadOnlyProperty(t){return this._createElement("readonlyPropTemplate","readonlyProps",".propValue",t)}_createInputField(t){const e=this._createElement("inputFieldTemplate","inputFields",".propInput",t);return e.name=t,e.autocomplete="off",e}_createElement(t,e,i,n){const s=document.getElementById(t).cloneNode(!0);return s.id="",s.querySelector(".propLabel").textContent=n,document.getElementById(e).appendChild(s),s.querySelector(i)}getInputs(){return[this.textInput]}}const at=["collection","function","object","input","output"];class ot{constructor(){this.elementTemplates=new Map,this.loadElementTemplates()}loadElementTemplates(){const t=document.getElementById("elementTemplates");if(!t)throw new Error("No template");Array.from(t.children).forEach(e=>{if(e instanceof HTMLElement&&e.classList.contains("template")){const i=at.find(n=>e.classList.contains(n));if(!i)throw new Error("Undefined type");this.elementTemplates.set(i,e)}})}createDOMElement(t,e){const i=this.elementTemplates.get(t.type);if(!i)throw new Error("No template");const n=i.cloneNode(!0);return n.classList.remove("template"),n.dataset.id=t.id,e.appendChild(n),n}updateElement(t,e,i,n,s,a){t.style.left=e.x+i.x-e.width/2+"px",t.style.top=e.y+i.y-e.height/2+"px",t.style.width=e.width+"px",t.style.height=e.height+"px",t.style.setProperty("--stroke-width",e.strokeWidth+"px"),t.style.setProperty("--depth",e.depth.toString());const r=t.querySelector(".element-text"),o=t.querySelector(".element-input");if(!r||!o)throw new Error("No text/input");r.textContent=e.text,o.value=e.text,this.updateStateClass(t,"child",!!e.parent),this.updateStateClass(t,"parent",!!e.children.length),this.updateStateClass(t,"anchored",e.isAnchored),this.updateStateClass(t,"selected",n),this.updateStateClass(t,"secondary",s),this.updateEditingState(t,e,a)}updateStateClass(t,e,i){t.classList.toggle(e,i)}updateEditingState(t,e,i){const n=t.querySelector(".element-text"),s=t.querySelector(".element-input");!n||!s||(i?(n.style.display="none",s.style.display="block",s.focus(),s.value=e.text):(n.style.display="block",s.style.display="none",n.textContent=e.text))}}class rt{constructor(){this.createButtons=new Map,this.modeButtons=new Map,this.projectButtons=new Map,this.appearanceButtons=new Map,this.createButtons=this.getDict("[data-create]"),this.modeButtons=this.getDict("[data-mode]"),this.projectButtons=this.getDict("[data-project]"),this.appearanceButtons=this.getDict("[data-appearance]")}setupActiveButtonGroup(t,e){document.querySelectorAll(t).forEach(i=>{i.addEventListener("click",()=>{i.classList.contains("toggle")?i.classList.toggle("active"):(document.querySelectorAll(t).forEach(r=>{r.classList.contains("toggle")||r.classList.remove("active")}),i.classList.add("active"));const s=t.replace("[data-","").replace("]",""),a=i.dataset[s];a&&e(a)})})}updateCreate(t,e=!1){this.createButtons.forEach((i,n)=>{n!==t?i.classList.remove("active"):i.classList.add(e?"danger":"active")})}updateMode(t){const e=t==="remove"||t==="disconnect";this.modeButtons.forEach((i,n)=>{n!==t?i.classList.remove("active"):i.classList.add(e&&n==="create"?"danger":"active")})}updateAppearance(t=!0,e=!0){var i,n;this.appearanceButtons.forEach(s=>s.classList.remove("active")),t&&((i=this.appearanceButtons.get("layout"))==null||i.classList.add("active")),e&&((n=this.appearanceButtons.get("details"))==null||n.classList.add("active"))}getDict(t){const e=new Map,i=t.replace("[data-","").replace("]","");return document.querySelectorAll(t).forEach(n=>{const s=n,a=s.dataset[i];if(!a)throw new Error(`No value (key: ${i})`);e.set(a,s)}),e}}class ct{constructor(t,e){this.canvas=t,this.state=e,this.elementMap=new Map,this.connectionMap=new Map,this.propertiesPanel=new nt,this.topBar=new rt,this.elementFactory=new ot,this.updateCanvasCursor()}render(){var t;this.updateStatus(),this.updateCanvasCursor(),this.setCanvasTransform(this.state.zoom),this.renderElements(this.state.elements,((t=this.state.selectedElement)==null?void 0:t.id)??void 0),this.renderConnections(this.state.connections),this.propertiesPanel.updatePanel(this.state.details?this.state.selectedElement:void 0),this.topBar.updateCreate(this.state.elementType,this.state.currentMode==="remove"),this.topBar.updateMode(this.state.currentMode),this.topBar.updateAppearance(this.state.layout,this.state.details),this.state.rerenderNeeded=!1}renderElements(t,e){const i=new Set(t.map(s=>s.id));for(const[s,a]of this.elementMap)i.has(s)||(a.remove(),this.elementMap.delete(s));t.forEach(s=>{var r,o;let a=this.elementMap.get(s.id);a||(a=this.elementFactory.createDOMElement(s,this.canvas),this.elementMap.set(s.id,a)),this.elementFactory.updateElement(a,s,this.state.pan,s.id===e,((r=this.state.fromElement)==null?void 0:r.id)===s.id,((o=this.state.editingElement)==null?void 0:o.id)===s.id)});const n=this.state.targetPosition;this.state.contextMenu&&n?this.showContextMenu(n.x,n.y):this.hideContextMenu()}renderConnections(t){const e=new Set(t.map(i=>i.id));for(const[i,n]of this.connectionMap)e.has(i)||(n.remove(),this.connectionMap.delete(i));t.forEach(i=>{const n=i.from,s=i.to;if(!n||!s)return;let a=this.connectionMap.get(i.id);a||(a=this.createConnectionDOM(),this.connectionMap.set(i.id,a)),this.updateConnectionDOM(a,n,s)})}createConnectionDOM(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.classList.add("connection-svg");const e=document.createElementNS("http://www.w3.org/2000/svg","line");return e.classList.add("connection-line"),t.appendChild(e),this.canvas.appendChild(t),t}updateConnectionDOM(t,e,i){const n=t.querySelector("line");if(!n)return;const s=e.x,a=e.y,r=i.x,o=i.y,c=20,l=Math.min(s,r)-c,d=Math.min(a,o)-c,u=Math.max(s,r)+c,A=Math.max(a,o)+c;t.style.left=l+"px",t.style.top=d+"px",t.style.width=u-l+"px",t.style.height=A-d+"px";const R=s-l,f=a-d,T=r-l,F=o-d;n.setAttribute("x1",R.toString()),n.setAttribute("y1",f.toString()),n.setAttribute("x2",T.toString()),n.setAttribute("y2",F.toString())}showContextMenu(t,e){const i=document.getElementById("contextMenu"),n=this.canvas.getBoundingClientRect();if(i){let s=n.left+t,a=n.top+e;s+i.offsetWidth>window.innerWidth-20&&(s=window.innerWidth-i.offsetWidth-20),a+i.offsetHeight>window.innerHeight-20&&(a=window.innerHeight-i.offsetHeight-20),i.style.left=s+"px",i.style.top=a+"px",i.classList.remove("hidden")}}hideContextMenu(){const t=document.getElementById("contextMenu");t&&t.classList.add("hidden")}getActivePanelInputs(){return this.propertiesPanel.getInputs()}updateCanvasCursor(){const t=document.getElementById("canvasContainer");if(!t)return;const e=["create","remove","move","edit"];e.forEach(i=>t.classList.remove(`cursor-${i}`)),e.includes(this.state.currentMode)&&t.classList.add(`cursor-${this.state.currentMode}`)}updateStatus(){const t={create:"Create Mode",remove:"Remove Mode",connect:"Connect Mode",disconnect:"Disconnect Mode",move:"Move Mode",edit:"Edit Mode"},e={collection:"Collection",function:"Function",object:"Object",input:"Input",output:"Output"};let i=t[this.state.currentMode];this.state.currentMode==="create"&&(i+=` - ${e[this.state.elementType]}`),this.state.editingElement&&(i+=" - Editing");const n=document.getElementById("status");n&&(n.textContent=i)}setCanvasTransform(t){const e=1/t;this.canvas.style.width=`${100*e}%`,this.canvas.style.height=`${100*e}%`,this.canvas.style.transform=`scale(${t})`,this.canvas.style.transformOrigin="0 0"}}class ht{constructor(t,e,i,n){this.canvas=t,this.inputState=e,this.getElementsCallback=i,this.getPanelInputsCallback=n,this.withCanvasCoordinates=(s,a)=>{const{x:r,y:o}=this.getCanvasCoordinates(s),c=this.findElementAt(r,o);a(r,o,c)},this.handleClick=s=>{this.withCanvasCoordinates(s,(a,r,o)=>{this.inputState.onClick(a,r,o==null?void 0:o.id)})},this.handleMouseDown=s=>{this.withCanvasCoordinates(s,(a,r,o)=>{this.inputState.onMouseDown(a,r,o)})},this.handleMouseUp=()=>{this.inputState.onMouseUp()},this.handleMouseMove=s=>{if(this.inputState.currentMode!=="move"||!this.inputState.activeId)return;const{x:a,y:r}=this.getCanvasCoordinates(s);this.inputState.onDrag(this.inputState.activeId,a,r),s.preventDefault()},this.handleDoubleClick=s=>{this.withCanvasCoordinates(s,(a,r,o)=>{o&&this.inputState.onDoubleClick(a,r,o.id)})},this.handleContextMenu=s=>{s.preventDefault(),this.withCanvasCoordinates(s,(a,r,o)=>{this.inputState.onContextMenu(a,r,o==null?void 0:o.id)})},this.handleInput=s=>{const a=s.target;if(!a||a.tagName!=="INPUT"||!this.inputState.activeId)return;const r=a.closest(".element"),o=(r==null?void 0:r.dataset.id)===this.inputState.activeId,c=this.getPanelInputsCallback().includes(a);(o||c)&&this.inputState.executeAction("edit",a.value)},this.handleKeyDown=s=>{if(s.code==="Escape"){this.inputState.clear();return}if(s.key==="Shift"){this.inputState.shiftKey=!0;return}const a=this.getKeyboardShortcuts();if(s.ctrlKey||s.metaKey){const o=a.withCtrl[s.code];if(o){s.preventDefault(),o();return}}const r=a.normal[s.code];if(r){r();return}this.inputState.isEditing&&s.key==="Enter"&&(this.inputState.executeAction("select"),s.preventDefault())},this.handleKeyUp=s=>{s.key==="Shift"&&(this.inputState.shiftKey=!1)},this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("click",this.handleClick),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("dblclick",this.handleDoubleClick),this.canvas.addEventListener("contextmenu",this.handleContextMenu),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),window.addEventListener("input",this.handleInput),this.setupButtons(),this.setupPopupButtons()}setupPopupButtons(){const t=document.querySelector("#popup .closeBtn");if(!t)throw new Error("Popup button absent");t.addEventListener("click",()=>this.inputState.executeAction("select"))}setupButtonGroup(t,e){document.querySelectorAll(t).forEach(i=>{i.addEventListener("click",()=>{const n=t.replace("[data-","").replace("]",""),s=i.dataset[n];s&&e(s)})})}setupButtons(){this.setupButtonGroup("[data-create]",t=>this.inputState.setElementType(t)),this.setupButtonGroup("[data-mode]",t=>this.inputState.setMode(t)),this.setupButtonGroup("[data-project]",t=>this.inputState.executeAction(t)),this.setupButtonGroup("[data-appearance]",t=>this.inputState.executeAction(t)),this.setupButtonGroup("[data-option]",t=>this.inputState.executeAction(t))}getCanvasCoordinates(t){const e=this.canvas.getBoundingClientRect(),{zoom:i,pan:n}=this.inputState;return{x:(t.clientX-e.left)/i-n.x,y:(t.clientY-e.top)/i-n.y}}getKeyboardShortcuts(){return{normal:{KeyQ:()=>this.inputState.setMode("create"),KeyW:()=>this.inputState.setMode("move"),KeyE:()=>this.inputState.setMode("edit"),F2:()=>this.inputState.activeId&&this.inputState.executeAction("edit"),KeyA:()=>this.inputState.activeId&&this.inputState.executeAction("anchor"),Delete:()=>this.handleDeleteKey(),Backspace:()=>this.handleDeleteKey()},withCtrl:{KeyS:()=>this.inputState.executeAction("export"),KeyO:()=>this.inputState.executeAction("import"),Equal:()=>this.inputState.executeAction("zoomIn"),NumpadAdd:()=>this.inputState.executeAction("zoomIn"),Minus:()=>this.inputState.executeAction("zoomOut"),NumpadSubtract:()=>this.inputState.executeAction("zoomOut"),Digit0:()=>this.inputState.executeAction("zoomReset"),Numpad0:()=>this.inputState.executeAction("zoomReset")}}}handleDeleteKey(){this.inputState.activeId&&!this.inputState.isEditing&&this.inputState.executeAction("delete")}findElementAt(t,e){const i=this.getElementsCallback();for(let n=i.length-1;n>=0;n--){const s=i[n],a={left:s.x-s.width/2,right:s.x+s.width/2,top:s.y-s.height/2,bottom:s.y+s.height/2};if(t>=a.left&&t<=a.right&&e>=a.top&&e<=a.bottom)return s}}}class dt{constructor(){this.currentMode="create",this.elementType="object",this.elements=[],this.connections=[],this.zoom=1,this.pan={x:0,y:0},this.contextMenu=!1,this.rerenderNeeded=!1,this.layout=!0,this.details=!0}setMode(t){this.currentMode=t}addElement(t){this.elements.push(t)}removeElement(t){const e=this.elements.findIndex(i=>i.id===t);e!==-1&&this.elements.splice(e,1)}addConnection(t){this.connections.push(t)}removeConnection(t){const e=this.connections.findIndex(i=>i.id===t);e!==-1&&this.connections.splice(e,1)}removeConnectionsFor(t){this.connections=this.connections.filter(e=>e.from.id!==t&&e.to.id!==t)}getElementById(t){return this.elements.find(e=>e.id===t)}getRootElements(t){return this.elements.filter(e=>!e.parent&&((t==null?void 0:t(e))??!0))}selectElement(t){this.selectedElement=t}hasConnection(t,e){return this.connections.some(i=>i.from.id===t&&i.to.id===e||i.from.id===e&&i.to.id===t)}serialize(){return JSON.stringify({elements:this.elements.map(t=>t.serialize()),connections:this.connections.map(t=>t.serialize())})}deserialize(t){const e=JSON.parse(t);this.clear();const i=new Map,n=new Map;this.elements=e.elements.map(s=>{const a=new z(s.type,s.x,s.y);return a.id=s.id,a.text=s.text,i.set(a.id,a),s.parentId&&n.set(a.id,s.parentId),a});for(const[s,a]of n){const r=i.get(s),o=i.get(a);r&&o&&(r.parent=o,o.children.includes(r)||(o.children.push(r),o.calculateSize()))}this.connections=e.connections.map(s=>{const a=this.getElementById(s.from),r=this.getElementById(s.to);if(!a||!r)throw new Error(`Invalid connection: missing element (from: ${s.from}, to: ${s.to})`);const o=new Y(a,r);return o.id=s.id,o})}clear(){this.elements=[],this.connections=[],this.selectedElement=void 0,this.fromElement=void 0,this.zoom=1,this.pan={x:0,y:0},this.editingElement=void 0,this.contextMenu=!1,this.targetPosition=void 0}}class lt{constructor(t){this.appState=new dt,this.inputState=new G,this.logicLayer=new st(this.inputState,this.appState,t),this.renderLayer=new ct(t,this.appState),this.inputLayer=new ht(t,this.inputState,()=>this.appState.elements,()=>this.renderLayer.getActivePanelInputs()),this.start()}start(){const t=()=>{try{(this.appState.rerenderNeeded||this.appState.layout)&&(this.logicLayer.processInput(),this.renderLayer.render(),this.inputState.clear())}catch(e){console.error("Error in update cycle:",e)}requestAnimationFrame(t)};requestAnimationFrame(t)}save(){return this.appState.serialize()}load(t){try{this.appState.deserialize(t),this.renderLayer.render()}catch(e){console.error("Failed to load data:",e)}}exportModel(){return this.appState.serialize()}importModel(t){this.appState.deserialize(JSON.stringify(t)),this.renderLayer.render()}}const j={selected:"var(--color-yellow)",child:"var(--color-orange)",parent:"var(--color-green)",anchored:"var(--color-purple)",secondary:"var(--color-blue)"};function ut(h){if(h.length===0)return"radial-gradient(circle, rgba(156, 163, 175, 0.3) 0%, transparent 100%)";if(h.length===1)return`radial-gradient(circle, ${j[h[0]]} 0%, transparent 100%)`;const t=360/h.length;return`conic-gradient(${h.map((i,n)=>{const s=n*t,a=(n+1)*t;return`${j[i]} ${s}deg ${a}deg`}).join(", ")})`}function N(h){const t=[];Object.keys(j).forEach(i=>{h.classList.contains(i)&&t.push(i)});const e=ut(t);h.style.setProperty("--element-gradient",e)}function pt(){const h=new MutationObserver(e=>{e.forEach(i=>{if(i.type==="attributes"&&i.attributeName==="class"){const n=i.target;n.classList.contains("element")&&N(n)}})});document.querySelectorAll(".element").forEach(e=>{h.observe(e,{attributes:!0,attributeFilter:["class"]}),N(e)}),new MutationObserver(e=>{e.forEach(i=>{i.addedNodes.forEach(n=>{n instanceof HTMLElement&&n.classList.contains("element")&&(h.observe(n,{attributes:!0,attributeFilter:["class"]}),N(n))})})}).observe(document.body,{childList:!0,subtree:!0})}document.addEventListener("DOMContentLoaded",()=>{try{const h=document.getElementById("canvas"),t=new lt(h);window.app=t}catch(h){console.error("Failed to initialize application:",h)}});pt();
