var w=c=>{throw TypeError(c)};var b=(c,t,i)=>t.has(c)||w("Cannot "+i);var A=(c,t,i)=>(b(c,t,"read from private field"),i?i.call(c):t.get(c)),L=(c,t,i)=>t.has(c)?w("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(c):t.set(c,i),C=(c,t,i,e)=>(b(c,t,"write to private field"),e?e.call(c,i):t.set(c,i),i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();var x;class F{constructor(){L(this,x);C(this,x,"none"),this.elementType="object",this.currentMode="create",this.shiftKey=!1,this.isEditing=!1,this.zoom=1,this.pan={x:0,y:0}}get getAction(){return A(this,x)}setAction(t){C(this,x,t),t==="edit"?this.isEditing=!0:t!=="none"&&(this.isEditing=!1,this.text=void 0,t!=="connect"&&(this.secondaryId=void 0))}clear(){this.setAction("none")}interpretClick(t,i,e,n=!1){switch(this.mousePosition={x:t,y:i},this.shiftKey=n,this.currentMode){case"create":this.setAction(e&&n?"delete":"create"),this.activeId=e;return;case"connect":{if(!e){this.activeId=void 0,this.setAction("select");return}const s=this.secondaryId!==e?this.secondaryId:this.activeId!==e?this.activeId:void 0;if(!s){this.setAction("select");break}this.secondaryId=s,this.setAction("connect");break}case"edit":this.setAction(e?"edit":"none");break;case"move":this.setAction(e?"select":"none");break}this.activeId=e??this.activeId}resetConnectionState(){this.secondaryId=void 0,this.currentMode==="connect"&&(this.activeId=void 0,this.setAction("none"))}interpretModeChange(t){this.currentMode=t,this.setAction("changeMode")}interpretDrag(t,i,e){if(this.currentMode!=="move"||!this.dragOffset)return;this.setAction("move");const n=i-this.dragOffset.x,s=e-this.dragOffset.y;this.secondaryId=t,this.mousePosition={x:n,y:s}}interpretMouseDown(t,i,e){this.text=void 0,this.mousePosition={x:t,y:i},this.secondaryId=e==null?void 0:e.id,e&&this.currentMode==="move"&&(this.dragOffset={x:t-e.x,y:i-e.y})}interpretMouseUp(){this.currentMode==="move"&&(this.dragOffset=void 0)}interpretDoubleClick(t,i,e){e&&(this.setAction("edit"),this.activeId=e,this.mousePosition={x:t,y:i})}interpretContextMenu(t,i,e){(e||this.activeId)&&this.setAction("menu"),e&&(this.activeId=e,this.mousePosition={x:t,y:i})}interpretContextMenuOption(t){if(this.activeId)switch(this.setAction(t),t){case"duplicate":this.setAction("create"),this.activeId=void 0;break;default:this.setAction(t)}}interpretControlsAction(t){switch(this.setAction(t),t){case"zoomIn":this.zoom*=1.2;break;case"zoomOut":this.zoom/=1.2;break;case"resetView":this.zoom=1,this.pan={x:0,y:0};break}}interpretTextEdit(t,i){this.setAction("edit"),this.activeId=t,this.text=i}interpretActionOnElement(t,i){switch(this.activeId=i,t){case"delete":this.setAction("delete"),this.activeId=i;break;case"anchor":this.setAction("anchor");break}}}x=new WeakMap;const I=125;class O{constructor(t,i={}){this.canvasElement=t,this.velocities=new Map,this.forces=new Map,this.spatialHash=new Map,this.connectionMap=new Map,this.isRunning=!1,this.canvasCenter={x:0,y:0},this.animate=(e,n)=>{if(this.isRunning){if(this.step(e)<this.config.stopThreshold){this.stop();return}this.animationId=requestAnimationFrame(()=>this.animate(e,n))}},this.config={repulsionForce:2e3,attractionForce:.5,damping:.5,minDistance:I,maxForce:10,iterations:1,springLength:I,movementThreshold:.1,stopThreshold:.05,gridForce:.08,centerAttractionForce:.005,gridSize:I,spatialHashSize:300,maxRepulsionDistance:250,connectionGridAlignForce:.1,gridRepulsionFactor:.5,perfectAlignmentThreshold:5,...i}}setCanvasElement(t){this.canvasElement=t}getCanvasCenter(){if(!this.canvasElement)return{x:0,y:0};const t=this.canvasElement.getBoundingClientRect();return{x:t.width/2,y:t.height/2}}start(t,i){this.isRunning||(this.isRunning=!0,this.velocities.clear(),this.forces.clear(),t.forEach(e=>{this.velocities.set(e.id,{x:0,y:0}),this.forces.set(e.id,{x:0,y:0})}),this.connectionMap.clear(),i.forEach(e=>{this.connectionMap.has(e.from.id)||this.connectionMap.set(e.from.id,[]),this.connectionMap.has(e.to.id)||this.connectionMap.set(e.to.id,[]),this.connectionMap.get(e.from.id).push(e.to),this.connectionMap.get(e.to.id).push(e.from)}),this.animate(t,i))}stop(){this.isRunning=!1,this.animationId&&cancelAnimationFrame(this.animationId)}step(t){if(!t.length)return 0;let i=0;for(let e=0;e<this.config.iterations;e++)this.calculateForces(t),i=this.updatePositions(t);return i}calculateForces(t){this.canvasCenter=this.getCanvasCenter(),this.spatialHash.clear(),t.forEach(i=>{const e=`${Math.floor(i.x/this.config.spatialHashSize)},${Math.floor(i.y/this.config.spatialHashSize)}`;(this.spatialHash.get(e)||this.spatialHash.set(e,[]).get(e)).push(i)}),t.forEach(i=>{const e=this.forces.get(i.id);e.x=e.y=0}),t.forEach(i=>{var l;if(i.isAnchored)return;const e=this.forces.get(i.id),n=Math.floor(i.x/this.config.spatialHashSize),s=Math.floor(i.y/this.config.spatialHashSize);for(let d=-1;d<=1;d++)for(let f=-1;f<=1;f++){const S=this.spatialHash.get(`${n+d},${s+f}`);S&&S.forEach(p=>{if(i.id===p.id)return;const u=i.x-p.x,g=i.y-p.y,v=u*u+g*g;if(v>this.config.maxRepulsionDistance**2)return;if(v===0){e.x+=Math.random()-.5,e.y+=Math.random()-.5;return}const m=Math.sqrt(v);let y=this.config.repulsionForce/v;m<this.config.minDistance&&(y+=(this.config.minDistance-m)*this.config.repulsionForce*.01);const M=Math.abs(u%this.config.gridSize)<5||Math.abs(u%this.config.gridSize)>this.config.gridSize-5,E=Math.abs(g%this.config.gridSize)<5||Math.abs(g%this.config.gridSize)>this.config.gridSize-5;(M||E)&&(y*=this.config.gridRepulsionFactor),e.x+=u/m*y,e.y+=g/m*y})}(l=this.connectionMap.get(i.id))==null||l.forEach(d=>{const f=d.x-i.x,S=d.y-i.y,p=Math.sqrt(f*f+S*S);if(p===0)return;const u=(p-this.config.springLength)*this.config.attractionForce;e.x+=f/p*u,e.y+=S/p*u;const g=Math.atan2(S,f),v=10*Math.PI/180;if(Math.abs(g)<v||Math.abs(g-Math.PI)<v){const m=Math.round(i.y/this.config.gridSize)*this.config.gridSize;e.y+=(m-i.y)*this.config.connectionGridAlignForce;const y=Math.round(d.y/this.config.gridSize)*this.config.gridSize;this.forces.get(d.id).y+=(y-d.y)*this.config.connectionGridAlignForce}else if(Math.abs(g-Math.PI/2)<v||Math.abs(g+Math.PI/2)<v){const m=Math.round(i.x/this.config.gridSize)*this.config.gridSize;e.x+=(m-i.x)*this.config.connectionGridAlignForce;const y=Math.round(d.x/this.config.gridSize)*this.config.gridSize;this.forces.get(d.id).x+=(y-d.x)*this.config.connectionGridAlignForce}});const o=Math.round(i.x/this.config.gridSize)*this.config.gridSize,a=Math.round(i.y/this.config.gridSize)*this.config.gridSize;e.x+=(o-i.x)*this.config.gridForce,e.y+=(a-i.y)*this.config.gridForce,e.x+=(this.canvasCenter.x-i.x)*this.config.centerAttractionForce,e.y+=(this.canvasCenter.y-i.y)*this.config.centerAttractionForce;const r=Math.sqrt(e.x*e.x+e.y*e.y);r>this.config.maxForce&&(e.x=e.x/r*this.config.maxForce,e.y=e.y/r*this.config.maxForce);const h=this.velocities.get(i.id);h.x=(h.x+e.x)*this.config.damping,h.y=(h.y+e.y)*this.config.damping})}updatePositions(t){let i=0;return t.forEach(e=>{if(e.isAnchored)return;const n=this.velocities.get(e.id);Math.sqrt(n.x*n.x+n.y*n.y)>this.config.movementThreshold&&(e.x+=n.x,e.y+=n.y);const o=e.x%this.config.gridSize,a=e.y%this.config.gridSize,r=Math.abs(o)<this.config.perfectAlignmentThreshold||Math.abs(o-this.config.gridSize)<this.config.perfectAlignmentThreshold||Math.abs(o+this.config.gridSize)<this.config.perfectAlignmentThreshold,h=Math.abs(a)<this.config.perfectAlignmentThreshold||Math.abs(a-this.config.gridSize)<this.config.perfectAlignmentThreshold||Math.abs(a+this.config.gridSize)<this.config.perfectAlignmentThreshold;if(r){const l=Math.round(e.x/this.config.gridSize)*this.config.gridSize;Math.abs(l-e.x)>.01&&(i+=Math.abs(l-e.x),e.x=l)}if(h){const l=Math.round(e.y/this.config.gridSize)*this.config.gridSize;Math.abs(l-e.y)>.01&&(i+=Math.abs(l-e.y),e.y=l)}}),i}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}}class z{constructor(t,i){this.id=(Date.now()+Math.random()).toString(),this.from=t,this.to=i,t.connections.push(this),i.connections.push(this)}serialize(){return{id:this.id,from:this.from.id,to:this.to.id}}}class k{constructor(t,i,e,n=void 0,s=!1){this.type=t,this.x=i,this.y=e,this.parent=n,this.id=(Date.now()+Math.random()).toString(),this.text=this.getDefaultText(),this.width=this.getDefaultWidth(),this.height=this.getDefaultHeight(),this.children=[],this.connections=[],this.isAnchored=s,n&&n.children.push(this)}get cornerX(){return this.x-this.width/2}get cornerY(){return this.y-this.height/2}getDefaultText(){return{collection:"Collection",function:"Function",object:"Object",input:"Input",output:"Output"}[this.type]||"AppElement"}getDefaultWidth(){return{collection:120,function:100,object:90,input:80,output:80}[this.type]||100}getDefaultHeight(){return{collection:80,function:60,object:78,input:40,output:40}[this.type]||60}serialize(){return{id:this.id,type:this.type,x:this.x,y:this.y,text:this.text,width:this.width,height:this.height,parentId:this.parent?this.parent.id:void 0,childIds:this.children.map(t=>t.id),connectionIds:this.connections.map(t=>t.id),isAnchored:this.isAnchored}}}class T{constructor(t){this.appState=t}saveProject(){const t=this.appState.serialize(),i=new Blob([t],{type:"application/json"}),e=URL.createObjectURL(i),n=document.createElement("a");n.href=e,n.download="application_design.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(e)}loadProject(){return new Promise((t,i)=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=n=>{var a;const o=(a=n.target.files)==null?void 0:a[0];if(o){const r=new FileReader;r.onload=h=>{var l;try{const d=(l=h.target)==null?void 0:l.result;typeof d=="string"?(this.appState.deserialize(d),this.appState.rerenderNeeded=!0,t()):i(new Error("Failed to read file as text"))}catch(d){const f=d instanceof Error?d.message:"Unknown error";alert("Error loading project: "+f),i(d)}},r.onerror=()=>{const h=new Error("Failed to read file");alert("Error reading file"),i(h)},r.readAsText(o)}else i(new Error("No file selected"))},e.oncancel=()=>{t()},document.body.appendChild(e),e.click(),document.body.removeChild(e)})}}class D{constructor(t,i,e){this.inputState=t,this.appState=i,this.projectManager=new T(i),this.layout=new O(e)}processInput(){let t=this.inputState.activeId,i=this.inputState.secondaryId;switch(this.inputState.isEditing||(this.appState.editingElement=void 0),this.inputState.getAction){case"layout":this.appState.autoLayout=!this.appState.autoLayout,this.appState.autoLayout?this.restartLayout():this.layout.stop();break;case"create":this.appState.contextMenu=!1,t=this.handleCreate(),this.tryRestartLayout();break;case"move":this.handleMove(),this.tryRestartLayout();break;case"connect":this.handleConnect(),t=this.inputState.activeId,i=void 0,this.tryRestartLayout();break;case"select":t=this.handleSelect();break;case"anchor":this.handleAnchor();break;case"delete":this.appState.contextMenu=!1,this.handleDelete(),this.tryRestartLayout(),t=void 0;break;case"edit":this.appState.contextMenu=!1,this.handleEdit();break;case"menu":this.appState.contextMenu=!0,this.appState.targetPosition=this.inputState.mousePosition;break;case"save":this.projectManager.saveProject();break;case"load":this.projectManager.loadProject(),this.tryRestartLayout();break;case"clear":this.appState.clear(),this.layout.stop();break;case"zoomIn":case"zoomOut":case"resetView":this.appState.zoom=this.inputState.zoom,this.appState.pan=this.inputState.pan;break;case"changeMode":this.appState.currentMode=this.inputState.currentMode;break}this.appState.selectedElement=t?this.appState.getElementById(t):void 0,this.appState.fromElement=i?this.appState.getElementById(i):void 0,this.inputState.activeId=t,this.inputState.secondaryId=i}handleCreate(){if(!this.inputState.mousePosition)return;const{x:t,y:i}=this.inputState.mousePosition,e=this.inputState.activeId,n=e?this.appState.getElementById(e)??void 0:void 0,s=new k(this.inputState.elementType,t,i,n);return this.appState.addElement(s),this.inputState.activeId=s.id,s.id}handleMove(){if(this.inputState.secondaryId&&this.inputState.mousePosition){const t=this.appState.getElementById(this.inputState.secondaryId);t&&(t.x=this.inputState.mousePosition.x,t.y=this.inputState.mousePosition.y)}}handleConnect(){const t=this.appState.getElementById(this.inputState.secondaryId),i=this.appState.getElementById(this.inputState.activeId);if(!this.appState.connections.some(n=>n.from.id===t.id&&n.to.id===i.id||n.from.id===i.id&&n.to.id===t.id)){const n=new z(t,i);this.appState.addConnection(n)}}handleSelect(){return this.inputState.activeId}handleAnchor(){const t=this.appState.getElementById(this.inputState.activeId);t.isAnchored=!t.isAnchored}handleDelete(){const t=i=>{const e=this.appState.getElementById(i);e&&(e.children.forEach(n=>t(n.id)),this.appState.removeConnectionsFor(e.id),this.appState.removeElement(i))};this.inputState.activeId&&t(this.inputState.activeId)}handleEdit(){if(this.inputState.activeId){const t=this.appState.getElementById(this.inputState.activeId);this.appState.editingElement=t,this.inputState.text!==void 0&&t&&(t.text=this.inputState.text)}}restartLayout(){this.layout.stop(),this.layout.start(this.appState.elements,this.appState.connections)}tryRestartLayout(){this.appState.autoLayout&&this.restartLayout()}}class R{constructor(t){this.panelContainer=document.getElementById("editbar"),this.textInput=this._createInputField("Name"),this.idField=this._createReadOnlyProperty("ID"),this.typeField=this._createReadOnlyProperty("Type"),this.xField=this._createReadOnlyProperty("Pos X"),this.yField=this._createReadOnlyProperty("Pos Y"),this.updatePanel=i=>{if(!i){this.panelContainer.classList.add("hidden");return}this.panelContainer.classList.remove("hidden"),this.idField.textContent=i.id.toString(),this.typeField.textContent=i.type,this.textInput.value=i.text,this.xField.textContent=Math.round(i.x).toString(),this.yField.textContent=Math.round(i.y).toString()},this.appState=t}_createReadOnlyProperty(t){return this._createElement("readonlyPropTemplate","readonlyProps",".propValue",t)}_createInputField(t){const i=this._createElement("inputFieldTemplate","inputFields",".propInput",t);return i.name=t,i.autocomplete="off",i}_createElement(t,i,e,n){const s=document.getElementById(t).cloneNode(!0);return s.id="",s.querySelector(".propLabel").textContent=n,document.getElementById(i).appendChild(s),s.querySelector(e)}getInputs(){return[this.textInput]}}class j{constructor(t,i){this.canvas=t,this.state=i,this.elementMap=new Map,this.connectionMap=new Map,this.propertiesPanel=new R(i)}render(){var t;this.updateStatus(),this.updateElementTypeSelection(),this.setCanvasTransform(this.state.zoom,this.state.pan.x,this.state.pan.y),this.renderElements(this.state.elements,((t=this.state.selectedElement)==null?void 0:t.id)??void 0),this.renderConnections(this.state.connections),this.propertiesPanel.updatePanel(this.state.selectedElement),this.state.rerenderNeeded=!1}renderElements(t,i){const e=new Set(t.map(s=>s.id));for(const[s,o]of this.elementMap)e.has(s)||(o.remove(),this.elementMap.delete(s));t.forEach(s=>{var l,d;let o=this.elementMap.get(s.id);o||(o=this.createElementDOM(s),this.elementMap.set(s.id,o));const a=s.id===i,r=((l=this.state.editingElement)==null?void 0:l.id)===s.id,h=((d=this.state.fromElement)==null?void 0:d.id)===s.id;this.updateElementDOM(o,s),a?o.classList.add("selected"):o.classList.remove("selected"),h?o.classList.add("connection-source"):o.classList.remove("connection-source"),this.updateEditingState(o,s,r)});const n=this.state.targetPosition;this.state.contextMenu&&n?this.showContextMenu(n.x,n.y):this.hideContextMenu()}createElementDOM(t){const i=document.createElement("div");i.className=`element ${t.type}`,i.dataset.id=t.id;const e=document.createElement("span");e.className="element-text",i.appendChild(e);const n=document.createElement("input");return n.className="element-input",n.type="text",n.style.display="none",n.style.background="rgba(0, 0, 0, 0.4)",n.style.border="1px solid #444",n.style.borderRadius="4px",n.style.outline="none",n.style.color="#eee",n.style.font="inherit",n.style.textAlign="center",n.style.width="calc(100% - 10px)",n.style.padding="2px 5px",n.style.boxSizing="border-box",n.style.textShadow="0 0 3px rgba(0,0,0,0.7)",i.appendChild(n),this.updateElementDOM(i,t),this.canvas.appendChild(i),i}updateElementDOM(t,i){t.style.left=i.x-i.width/2+"px",t.style.top=i.y-i.height/2+"px",t.style.width=i.width+"px",t.style.height=i.height+"px";const e=t.querySelector(".element-text"),n=t.querySelector(".element-input");e&&(e.textContent=i.text),n&&(n.value=i.text),i.parent?t.classList.add("has-parent"):t.classList.remove("has-parent")}updateEditingState(t,i,e){const n=t.querySelector(".element-text"),s=t.querySelector(".element-input");n&&s&&(e?(n.style.display="none",s.style.display="block",s.focus(),s.value=i.text):(n.style.display="block",s.style.display="none",n.textContent=i.text))}renderConnections(t){const i=new Set(t.map(e=>e.id));for(const[e,n]of this.connectionMap)i.has(e)||(n.remove(),this.connectionMap.delete(e));t.forEach(e=>{const n=e.from,s=e.to;if(!n||!s)return;let o=this.connectionMap.get(e.id);o?this.updateConnectionDOM(o,n,s):(o=this.createConnectionDOM(n,s),this.connectionMap.set(e.id,o))})}createConnectionDOM(t,i){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.classList.add("connection-svg"),e.style.position="absolute",e.style.pointerEvents="none",e.style.zIndex="1";const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.classList.add("connection-line");const s=document.createElementNS("http://www.w3.org/2000/svg","polygon");return s.classList.add("connection-arrow"),e.appendChild(n),e.appendChild(s),this.canvas.appendChild(e),this.updateConnectionDOM(e,t,i),e}updateConnectionDOM(t,i,e){const n=t.querySelector("line"),s=t.querySelector("polygon");if(!n||!s)return;const o=i.x,a=i.y,r=e.x,h=e.y,l=Math.min(o,r)-20,d=Math.min(a,h)-20,f=Math.max(o,r)+20,S=Math.max(a,h)+20;t.style.left=l+"px",t.style.top=d+"px",t.style.width=f-l+"px",t.style.height=S-d+"px",n.setAttribute("x1",(o-l).toString()),n.setAttribute("y1",(a-d).toString()),n.setAttribute("x2",(r-l).toString()),n.y2.baseVal.value=h-d;const p=Math.atan2(h-a,r-o),u=8,g=r-l,v=h-d,m=g-Math.cos(p)*(u/2),y=v-Math.sin(p)*(u/2),M=m-u*Math.cos(p-Math.PI/6),E=y-u*Math.sin(p-Math.PI/6),P=m-u*Math.cos(p+Math.PI/6),B=y-u*Math.sin(p+Math.PI/6);s.setAttribute("points",`${m},${y} ${M},${E} ${P},${B}`)}showContextMenu(t,i){const e=document.getElementById("contextMenu"),n=this.canvas.getBoundingClientRect();if(e){let s=n.left+t,o=n.top+i;s+e.offsetWidth>window.innerWidth-20&&(s=window.innerWidth-e.offsetWidth-20),o+e.offsetHeight>window.innerHeight-20&&(o=window.innerHeight-e.offsetHeight-20),e.style.left=s+"px",e.style.top=o+"px",e.classList.remove("hidden")}}hideContextMenu(){const t=document.getElementById("contextMenu");t&&t.classList.add("hidden")}getActivePanelInputs(){return this.propertiesPanel.getInputs()}updateElementTypeSelection(){const t=document.getElementById("elementTypeSelection");this.state.currentMode==="create"?t.classList.remove("hidden"):t.classList.add("hidden")}updateStatus(){const t={create:"Create/Child Mode",connect:"Connection Mode",move:"Movement Mode",edit:"Edit Mode"},i={collection:"Collections",function:"Functions",object:"Objects",input:"Inputs",output:"Outputs"};let e=`${t[this.state.currentMode]}`;this.state.currentMode==="create"&&(e+=` - ${i[this.state.currentElementType]}`),this.state.currentMode==="connect"&&this.state.fromElement&&(e+=" - Select target element");const n=document.getElementById("status");n&&(n.textContent=e)}setCanvasTransform(t,i,e){const n=1/t;this.canvas.style.width=`${100*n}%`,this.canvas.style.height=`${100*n}%`,this.canvas.style.transform=`scale(${t}) translate(${i}px, ${e}px)`,this.canvas.style.transformOrigin="0 0"}}class N{constructor(t,i,e,n){this.canvas=t,this.inputState=i,this.getElementsCallback=e,this.getPanelInputsCallback=n,this.handleClick=s=>{const o=this.getElementsCallback(),{x:a,y:r}=this.getCanvasCoordinates(s),h=this.findElementAt(o,a,r);this.inputState.interpretClick(a,r,h==null?void 0:h.id,s.shiftKey)},this.handleMouseDown=s=>{const{x:o,y:a}=this.getCanvasCoordinates(s),r=this.findElementAt(this.getElementsCallback(),o,a);this.inputState.interpretMouseDown(o,a,r)},this.handleMouseUp=()=>{this.inputState.interpretMouseUp()},this.handleMouseMove=s=>{const{x:o,y:a}=this.getCanvasCoordinates(s);this.inputState.secondaryId&&this.inputState.currentMode==="move"&&(this.getElementsCallback().find(l=>l.id===this.inputState.secondaryId)&&this.inputState.dragOffset&&this.inputState.interpretDrag(this.inputState.secondaryId,o,a),s.preventDefault())},this.handleDoubleClick=s=>{const{x:o,y:a}=this.getCanvasCoordinates(s),r=this.getElementsCallback(),h=this.findElementAt(r,o,a);h&&this.inputState.interpretDoubleClick(o,a,h.id)},this.handleContextMenu=s=>{s.preventDefault();const{x:o,y:a}=this.getCanvasCoordinates(s),r=this.findElementAt(this.getElementsCallback(),o,a);this.inputState.interpretContextMenu(o,a,r==null?void 0:r.id)},this.handleContextMenuOption=(s,o)=>{s.preventDefault(),this.inputState.interpretContextMenuOption(o)},this.handleControlsAction=(s,o)=>{s.preventDefault(),this.inputState.interpretControlsAction(o)},this.handleDirectAction=(s,o)=>{s.preventDefault(),this.inputState.setAction(o)},this.handleInput=s=>{const o=s.target;if(!o||o.tagName!=="INPUT")return;const a=this.inputState.activeId;if(!a)return;const r=o.closest(".element");if((r==null?void 0:r.dataset.id)===a&&this.inputState.isEditing){this.inputState.interpretTextEdit(a,o.value);return}this.getPanelInputsCallback().includes(o)&&a&&this.inputState.interpretTextEdit(a,o.value)},this.handleKeyDown=s=>{const o=this.inputState.activeId;if(o)switch(s.code){case"F2":this.inputState.interpretTextEdit(o);return;case"Escape":this.inputState.interpretActionOnElement("select",void 0);break;case"KeyA":this.inputState.interpretActionOnElement("anchor",o);break}this.inputState.isEditing&&o&&(s.key==="Escape"||s.key==="Enter")&&(this.inputState.setAction("select"),s.preventDefault())},this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("click",this.handleClick),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("dblclick",this.handleDoubleClick),this.setupModeButtons(),this.setupElementTypeButtons(),this.setupContextMenuEvents(),this.setupProjectEvents(),this.setupControlsEvents(),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("input",this.handleInput)}setupControlsEvents(){const t=document.getElementById("layoutBtn"),i=document.getElementById("zoomInBtn"),e=document.getElementById("zoomOutBtn"),n=document.getElementById("resetViewBtn");t.addEventListener("click",s=>{this.handleControlsAction(s,"layout"),t.classList.toggle("active")}),i.addEventListener("click",s=>this.handleControlsAction(s,"zoomIn")),e.addEventListener("click",s=>this.handleControlsAction(s,"zoomOut")),n.addEventListener("click",s=>this.handleControlsAction(s,"resetView"))}setupProjectEvents(){const t=document.getElementById("saveBtn"),i=document.getElementById("loadBtn"),e=document.getElementById("clearBtn");t&&t.addEventListener("click",n=>this.handleDirectAction(n,"save")),i&&i.addEventListener("click",n=>this.handleDirectAction(n,"load")),e&&e.addEventListener("click",n=>this.handleDirectAction(n,"clear"))}setupModeButtons(){document.querySelectorAll(".mode-btn, [data-mode]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".mode-btn, [data-mode]").forEach(e=>e.classList.remove("active")),t.classList.add("active");const i=t.dataset.mode;i&&this.inputState.interpretModeChange(i)})})}setupElementTypeButtons(){document.querySelectorAll(".element-btn, [data-type]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".element-btn, [data-type]").forEach(e=>e.classList.remove("active")),t.classList.add("active");const i=t.dataset.type;i&&(this.inputState.elementType=i)})})}setupContextMenuEvents(){var t,i,e;(t=document.getElementById("editBtn"))==null||t.addEventListener("click",n=>this.handleContextMenuOption(n,"edit")),(i=document.getElementById("duplicateBtn"))==null||i.addEventListener("click",n=>this.handleContextMenuOption(n,"duplicate")),(e=document.getElementById("deleteBtn"))==null||e.addEventListener("click",n=>this.handleContextMenuOption(n,"delete")),this.canvas.addEventListener("contextmenu",this.handleContextMenu)}getCanvasCoordinates(t){const i=this.canvas.getBoundingClientRect(),e=this.inputState.zoom,n=this.inputState.pan,s=(t.clientX-i.left)/e-n.x,o=(t.clientY-i.top)/e-n.y;return{x:s,y:o}}resetConnectionState(){this.inputState.resetConnectionState()}findElementAt(t,i,e){for(let n=t.length-1;n>=0;n--){const s=t[n],o=s.x-s.width/2,a=s.x+s.width/2,r=s.y-s.height/2,h=s.y+s.height/2;if(i>=o&&i<=a&&e>=r&&e<=h)return s}}}class q{constructor(){this.currentMode="create",this.currentElementType="object",this.elements=[],this.connections=[],this.dragging=!1,this.zoom=1,this.pan={x:0,y:0},this.contextMenu=!1,this.rerenderNeeded=!1,this.autoLayout=!0}setMode(t){this.currentMode=t}setElementType(t){this.currentElementType=t}addElement(t){this.elements.push(t)}removeElement(t){const i=this.elements.findIndex(e=>e.id===t);i!==-1&&this.elements.splice(i,1)}addConnection(t){this.connections.push(t)}removeConnection(t){const i=this.connections.findIndex(e=>e.id===t);i!==-1&&this.connections.splice(i,1)}removeConnectionsFor(t){this.connections=this.connections.filter(i=>i.from.id!==t&&i.to.id!==t)}getElementById(t){return this.elements.find(i=>i.id===t)}selectElement(t){var i;(i=this.selectedElement)!=null&&i.domElement&&this.selectedElement.domElement.classList.remove("selected"),this.selectedElement=t,t!=null&&t.domElement&&t.domElement.classList.add("selected")}hasConnection(t,i){return this.connections.some(e=>e.from.id===t&&e.to.id===i||e.from.id===i&&e.to.id===t)}serialize(){return JSON.stringify({elements:this.elements.map(t=>t.serialize()),connections:this.connections.map(t=>t.serialize())})}deserialize(t){const i=JSON.parse(t);this.clear();const e=new Map,n=new Map;this.elements=i.elements.map(s=>{const o=new k(s.type,s.x,s.y);return o.id=s.id,o.text=s.text,o.width=s.width,o.height=s.height,e.set(o.id,o),s.parentId&&n.set(o.id,s.parentId),o});for(const[s,o]of n){const a=e.get(s),r=e.get(o);a&&r&&(a.parent=r,r.children.includes(a)||r.children.push(a))}this.connections=i.connections.map(s=>{const o=this.getElementById(s.from),a=this.getElementById(s.to);if(!o||!a)throw new Error(`Invalid connection: missing element (from: ${s.from}, to: ${s.to})`);const r=new z(o,a);return r.id=s.id,r})}clear(){this.elements=[],this.connections=[],this.selectedElement=void 0,this.dragging=!1,this.fromElement=void 0,this.zoom=1,this.pan={x:0,y:0},this.editingElement=void 0,this.contextMenu=!1,this.targetPosition=void 0}}class ${constructor(t){this.appState=new q,this.inputState=new F,this.logicLayer=new D(this.inputState,this.appState,t),this.renderLayer=new j(t,this.appState),this.inputLayer=new N(t,this.inputState,()=>this.appState.elements,()=>this.renderLayer.getActivePanelInputs()),this.start()}start(){const t=()=>{try{(this.inputState.getAction!=="none"||this.appState.rerenderNeeded||this.appState.autoLayout)&&(this.logicLayer.processInput(),this.renderLayer.render(),this.inputState.clear())}catch(i){console.error("Error in update cycle:",i)}requestAnimationFrame(t)};requestAnimationFrame(t)}save(){return this.appState.serialize()}load(t){try{this.appState.deserialize(t),this.renderLayer.render()}catch(i){console.error("Failed to load data:",i)}}exportModel(){return this.appState.serialize()}importModel(t){this.appState.deserialize(JSON.stringify(t)),this.renderLayer.render()}}document.addEventListener("DOMContentLoaded",()=>{try{const c=document.getElementById("canvas"),t=new $(c);window.app=t}catch(c){console.error("Failed to initialize application:",c)}});
