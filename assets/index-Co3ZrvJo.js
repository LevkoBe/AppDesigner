var q=h=>{throw TypeError(h)};var H=(h,t,e)=>t.has(h)||q("Cannot "+e);var X=(h,t,e)=>(H(h,t,"read from private field"),e?e.call(h):t.get(h)),Y=(h,t,e)=>t.has(h)?q("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e),P=(h,t,e,i)=>(H(h,t,"write to private field"),i?i.call(h,e):t.set(h,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();var k;class W{constructor(){Y(this,k);P(this,k,"none"),this.elementType="object",this.currentMode="create",this.shiftKey=!1,this.isEditing=!1,this.zoom=1,this.pan={x:0,y:0}}get getAction(){return X(this,k)}setAction(t){P(this,k,t),t==="edit"?this.isEditing=!0:t!=="none"&&(this.isEditing=!1,this.text=void 0,t!=="connect"&&(this.secondaryId=void 0))}clear(){this.setAction("none")}interpretClick(t,e,i,s=!1){switch(this.mousePosition={x:t,y:e},this.shiftKey=s,this.currentMode){case"create":this.setAction(i&&s?"delete":"create"),this.activeId=i;return;case"connect":{if(!i){this.activeId=void 0,this.setAction("select");return}const n=this.secondaryId!==i?this.secondaryId:this.activeId!==i?this.activeId:void 0;if(!n){this.setAction("select");break}this.secondaryId=n,this.setAction("connect");break}case"edit":this.setAction(i?"edit":"none");break;case"move":this.setAction(i?"select":"none");break}this.activeId=i}resetConnectionState(){this.secondaryId=void 0,this.currentMode==="connect"&&(this.activeId=void 0,this.setAction("none"))}interpretModeChange(t){this.currentMode=t,this.setAction("changeMode")}interpretDrag(t,e,i){if(this.currentMode!=="move"||!this.dragOffset)return;this.setAction("move");const s=e-this.dragOffset.x,n=i-this.dragOffset.y;this.secondaryId=t,this.mousePosition={x:s,y:n}}interpretMouseDown(t,e,i){this.text=void 0,this.mousePosition={x:t,y:e},this.secondaryId=i==null?void 0:i.id,i&&this.currentMode==="move"&&(this.dragOffset={x:t-i.x,y:e-i.y})}interpretMouseUp(){this.currentMode==="move"&&(this.dragOffset=void 0)}interpretDoubleClick(t,e,i){i&&(this.setAction("edit"),this.activeId=i,this.mousePosition={x:t,y:e})}interpretContextMenu(t,e,i){(i||this.activeId)&&this.setAction("menu"),i&&(this.activeId=i,this.mousePosition={x:t,y:e})}interpretContextMenuOption(t){if(this.activeId)switch(this.setAction(t),t){case"duplicate":this.setAction("create"),this.activeId=void 0;break;default:this.setAction(t)}}interpretControlsAction(t){switch(this.setAction(t),t){case"zoomIn":this.zoom*=1.2;break;case"zoomOut":this.zoom/=1.2;break;case"resetView":this.zoom=1,this.pan={x:0,y:0};break}}interpretTextEdit(t,e){this.setAction("edit"),this.activeId=t,this.text=e}interpretActionOnElement(t,e){switch(this.activeId=e,t){case"delete":this.setAction("delete"),this.activeId=e;break;case"anchor":this.setAction("anchor");break}}}k=new WeakMap;const B=125;class K{constructor(t,e={}){this.canvasElement=t,this.velocities=new Map,this.forces=new Map,this.connectionMap=new Map,this.isRunning=!1,this.temperature=1,this.lastInteractionTime=Date.now(),this.coolingStartTime=0,this.ignoreElementIds=[],this.animate=(i,s)=>{if(!this.isRunning)return;const n=this.step(i),o=this.config.stopThreshold*(.1+this.temperature*.9);if(n<o&&this.temperature<=this.config.minTemperature){this.stop();return}this.animationId=requestAnimationFrame(()=>this.animate(i,s))},this.config={repulsionForce:2e3,attractionForce:.5,damping:.5,minDistance:B,maxForce:10,iterations:1,springLength:B,movementThreshold:.1,stopThreshold:.05,gridForce:.08,centerAttractionForce:.01,gridSize:B/2,spatialHashSize:300,maxRepulsionDistance:250,connectionGridAlignForce:.1,gridRepulsionFactor:.5,perfectAlignmentThreshold:5,annealingRate:.8,minTemperature:.05,coolingDelay:2e3,reheatOnInteraction:!0,childScaleFactor:.7,childCenterStrength:.15,...e}}setCanvasElement(t){this.canvasElement=t}getCanvasCenter(){return this.canvasElement?{x:this.canvasElement.offsetWidth/2,y:this.canvasElement.offsetHeight/2}:{x:0,y:0}}updateTemperature(){const t=Date.now();t-this.lastInteractionTime<this.config.coolingDelay||(this.coolingStartTime===0&&(this.coolingStartTime=t),this.temperature>this.config.minTemperature&&(this.temperature*=this.config.annealingRate,this.temperature=Math.max(this.temperature,this.config.minTemperature)))}getAllElements(t){const e=[],i=s=>{s.forEach(n=>{e.push(n),n.children&&n.children.length>0&&i(n.children)})};return i(t),e}initializeElementState(t){this.getAllElements(t).forEach(i=>{this.velocities.has(i.id)||this.velocities.set(i.id,{x:0,y:0}),this.forces.has(i.id)||this.forces.set(i.id,{x:0,y:0})})}buildConnectionMap(t){this.connectionMap.clear(),t.forEach(e=>{e.from.depth===e.to.depth&&(this.connectionMap.has(e.from.id)||this.connectionMap.set(e.from.id,[]),this.connectionMap.has(e.to.id)||this.connectionMap.set(e.to.id,[]),this.connectionMap.get(e.from.id).push(e.to),this.connectionMap.get(e.to.id).push(e.from))})}start(t,e,i){this.ignoreElementIds=i,!this.isRunning&&(this.isRunning=!0,this.velocities.clear(),this.forces.clear(),this.initializeElementState(t),this.buildConnectionMap(e),this.temperature=1,this.lastInteractionTime=Date.now(),this.coolingStartTime=0,this.animate(t,e))}stop(){this.isRunning=!1,this.animationId&&cancelAnimationFrame(this.animationId)}step(t){if(!t.length)return 0;this.updateTemperature();let e=0;for(let i=0;i<this.config.iterations;i++)e+=this.calculateForcesHierarchical(t,{center:this.getCanvasCenter(),depth:0}),e+=this.updatePositionsHierarchical(t);return e}calculateForcesHierarchical(t,e){let i=0;return i+=this.calculateForcesForLevel(t,e),t.forEach(s=>{if(s.children&&s.children.length>0){const n={center:{x:s.x,y:s.y},depth:e.depth+1,parentElement:s};i+=this.calculateForcesHierarchical(s.children,n)}}),i}calculateForcesForLevel(t,e){const{center:i,depth:s}=e,n=Math.pow(this.config.childScaleFactor,s),o=new Map,r=this.config.spatialHashSize*n;return t.forEach(a=>{const c=`${Math.floor(a.x/r)},${Math.floor(a.y/r)}`,d=o.get(c)||[];o.has(c)||o.set(c,d),d.push(a)}),t.forEach(a=>{const c=this.forces.get(a.id);c.x=c.y=0}),t.forEach(a=>{var $;if(a.isAnchored)return;const c=this.forces.get(a.id),d=Math.floor(a.x/r),l=Math.floor(a.y/r);for(let p=-1;p<=1;p++)for(let S=-1;S<=1;S++){const b=o.get(`${d+p},${l+S}`);b&&b.forEach(y=>{if(a.id===y.id||this.ignoreElementIds.includes(y.id))return;const w=a.x-y.x,x=a.y-y.y,v=w*w+x*x,I=this.config.maxRepulsionDistance*n;if(v>I**2)return;if(v===0){c.x+=(Math.random()-.5)*this.temperature*n,c.y+=(Math.random()-.5)*this.temperature*n;return}const E=Math.sqrt(v),m=this.config.minDistance*n;let M=this.config.repulsionForce*n/v*this.temperature;E<m&&(M+=(m-E)*this.config.repulsionForce*n*.01*this.temperature);const g=this.config.gridSize*n,U=Math.abs(w%g)<5*n||Math.abs(w%g)>g-5*n,G=Math.abs(x%g)<5*n||Math.abs(x%g)>g-5*n;(U||G)&&(M*=this.config.gridRepulsionFactor),c.x+=w/E*M,c.y+=x/E*M})}($=this.connectionMap.get(a.id))==null||$.forEach(p=>{if(a.depth!==p.depth)return;const S=p.x-a.x,b=p.y-a.y,y=Math.sqrt(S*S+b*b);if(y===0)return;const w=this.config.springLength*n,x=(y-w)*this.config.attractionForce*n*this.temperature;c.x+=S/y*x,c.y+=b/y*x;const v=Math.atan2(b,S),I=10*Math.PI/180,E=this.config.connectionGridAlignForce*n*this.temperature,m=this.config.gridSize*n;if(Math.abs(v)<I||Math.abs(v-Math.PI)<I){const M=Math.round(a.y/m)*m;c.y+=(M-a.y)*E;const g=Math.round(p.y/m)*m;this.forces.get(p.id).y+=(g-p.y)*E}else if(Math.abs(v-Math.PI/2)<I||Math.abs(v+Math.PI/2)<I){const M=Math.round(a.x/m)*m;c.x+=(M-a.x)*E;const g=Math.round(p.x/m)*m;this.forces.get(p.id).x+=(g-p.x)*E}});const u=this.config.gridSize*n,L=Math.round(a.x/u)*u,A=Math.round(a.y/u)*u,f=Math.max(.3,this.temperature);c.x+=(L-a.x)*this.config.gridForce*n*f,c.y+=(A-a.y)*this.config.gridForce*n*f;const F=s===0?this.config.centerAttractionForce:this.config.childCenterStrength;c.x+=(i.x-a.x)*F*n*this.temperature,c.y+=(i.y-a.y)*F*n*this.temperature;const R=this.config.maxForce*n*Math.max(.1,this.temperature),O=Math.sqrt(c.x*c.x+c.y*c.y);O>R&&(c.x=c.x/O*R,c.y=c.y/O*R);const j=this.config.damping*(.3+this.temperature*.7),T=this.velocities.get(a.id);T.x=(T.x+c.x)*j,T.y=(T.y+c.y)*j}),0}updatePositionsHierarchical(t){let e=0;return e+=this.updatePositionsForLevel(t,0),t.forEach(i=>{i.children&&i.children.length>0&&(e+=this.updatePositionsHierarchical(i.children))}),e}updatePositionsForLevel(t,e){let i=0;const s=Math.pow(this.config.childScaleFactor,e);return t.forEach(n=>{if(n.isAnchored||this.ignoreElementIds.includes(n.id))return;const o=this.velocities.get(n.id),r=Math.sqrt(o.x*o.x+o.y*o.y),a=this.config.movementThreshold*s*this.temperature;r>a&&(n.x+=o.x,n.y+=o.y,i+=r);const c=this.config.gridSize*s,d=n.x%c,l=n.y%c,u=this.config.perfectAlignmentThreshold*s*(2-this.temperature),L=Math.abs(d)<u||Math.abs(d-c)<u||Math.abs(d+c)<u,A=Math.abs(l)<u||Math.abs(l-c)<u||Math.abs(l+c)<u;if(L){const f=Math.round(n.x/c)*c;Math.abs(f-n.x)>.01&&(i+=Math.abs(f-n.x),n.x=f)}if(A){const f=Math.round(n.y/c)*c;Math.abs(f-n.y)>.01&&(i+=Math.abs(f-n.y),n.y=f)}}),i}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}reheatSimulation(){this.config.reheatOnInteraction&&(this.temperature=1,this.lastInteractionTime=Date.now(),this.coolingStartTime=0)}}class _{constructor(t,e){this.id=(Date.now()+Math.random()).toString(),this.from=t,this.to=e,t.connections.push(this),e.connections.push(this)}serialize(){return{id:this.id,from:this.from.id,to:this.to.id}}}const C=class C{constructor(t,e,i,s=void 0,n=!1){this.type=t,this.x=e,this.y=i,this.parent=s,this.strokeWidth=15,this.depth=0,this.id=(Date.now()+Math.random()).toString(),this.text=this.getDefaultText(),this.children=[],this.connections=[],this.isAnchored=n;const{widthRatio:o,heightRatio:r}=this.getDefaultRatios();this.widthRatio=o,this.heightRatio=r,this.size=C.BASE_SIZE_UNIT,this.calculateSize(),s&&(this.depth=s.depth+1,s.children.push(this),s.calculateSize())}get width(){return this.size*this.widthRatio}get height(){return this.size*this.heightRatio}calculateSize(){if(this.children.length===0)this.size=C.BASE_SIZE_UNIT;else{const i=this.children.reduce((o,r)=>o+r.width*r.height,0),s=this.widthRatio*this.heightRatio||1,n=Math.sqrt(i/s)*1.3;this.size=Math.max(n,C.BASE_SIZE_UNIT)}const t=this.widthRatio/this.heightRatio,e=C.BASE_SIZE_UNIT/this.size;this.strokeWidth=15*Math.pow(e,.4)*Math.sqrt(t)}getDefaultText(){return{collection:"Collection",function:"Function",object:"Object",input:"Input",output:"Output"}[this.type]||"AppElement"}getDefaultRatios(){return{collection:{widthRatio:1,heightRatio:1},function:{widthRatio:1.2,heightRatio:.8},object:{widthRatio:1,heightRatio:.8},input:{widthRatio:.8,heightRatio:.5},output:{widthRatio:.8,heightRatio:.5}}[this.type]||{widthRatio:1,heightRatio:1}}serialize(){return{id:this.id,type:this.type,x:this.x,y:this.y,text:this.text,parentId:this.parent?this.parent.id:void 0,childIds:this.children.map(t=>t.id),connectionIds:this.connections.map(t=>t.id),isAnchored:this.isAnchored}}};C.BASE_SIZE_UNIT=75;let z=C;class V{constructor(t){this.appState=t}saveProject(){const t=this.appState.serialize(),e=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download="application_design.json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}loadProject(){return new Promise((t,e)=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=s=>{var r;const o=(r=s.target.files)==null?void 0:r[0];if(o){const a=new FileReader;a.onload=c=>{var d;try{const l=(d=c.target)==null?void 0:d.result;typeof l=="string"?(this.appState.deserialize(l),this.appState.rerenderNeeded=!0,t()):e(new Error("Failed to read file as text"))}catch(l){const u=l instanceof Error?l.message:"Unknown error";alert("Error loading project: "+u),e(l)}},a.onerror=()=>{const c=new Error("Failed to read file");alert("Error reading file"),e(c)},a.readAsText(o)}else e(new Error("No file selected"))},i.oncancel=()=>{t()},document.body.appendChild(i),i.click(),document.body.removeChild(i)})}}class Z{constructor(){this.rules=[],this.registerRule(new J),this.registerRule(new Q),this.registerRule(new tt),this.registerRule(new et)}registerRule(t){this.rules.push(t)}evaluateConnection(t,e,i){const s={appState:i,fromElement:t,toElement:e};return this.rules.map(n=>n.evaluate(s))}evaluateElementCreation(t,e){const i={appState:e,element:t};return this.rules.map(s=>s.evaluate(i))}getBlockingResult(t){return t.find(e=>!e.allowed)||null}}class J{constructor(){this.name="Type Match",this.description="Outputs can only connect to compatible Inputs"}evaluate(t){const{fromElement:e,toElement:i}=t;return!e||!i?{allowed:!0,ruleName:this.name}:e.type==="output"&&i.type==="input"?{allowed:!0,ruleName:this.name}:{allowed:!0,ruleName:this.name}}}class Q{constructor(){this.name="No Loops",this.description="Prevents circular connections that would create loops"}evaluate(t){const{fromElement:e,toElement:i,appState:s}=t;return!e||!i||!s?{allowed:!0,ruleName:this.name}:this.wouldCreateCycle(e,i,s)?{allowed:!1,message:`Cannot connect ${e.text||e.type} to ${i.text||i.type}: would create a loop`,ruleName:this.name}:{allowed:!0,ruleName:this.name}}wouldCreateCycle(t,e,i){const s=new Set,n=(o,r)=>{if(o.id===r.id)return!0;if(s.has(o.id))return!1;s.add(o.id);const a=i.connections.filter(c=>c.from.id===o.id);for(const c of a)if(n(c.to,r))return!0;return!1};return n(e,t)}}class tt{constructor(){this.name="I/O Compatibility",this.description="Prevents incompatible input/output connections"}evaluate(t){const{fromElement:e,toElement:i}=t;return!e||!i?{allowed:!0,ruleName:this.name}:e.type==="input"&&i.type==="input"?{allowed:!1,message:`Cannot connect Input to Input: ${e.text||"Input"} → ${i.text||"Input"}`,ruleName:this.name}:e.type==="output"&&i.type==="output"?{allowed:!1,message:`Cannot connect Output to Output: ${e.text||"Output"} → ${i.text||"Output"}`,ruleName:this.name}:{allowed:!0,ruleName:this.name}}}class et{constructor(){this.name="Depth Matching",this.description="Connections should be between elements at compatible nesting levels"}evaluate(t){const{fromElement:e,toElement:i}=t;if(!e||!i)return{allowed:!0,ruleName:this.name};const s=this.getElementDepth(e),n=this.getElementDepth(i);return Math.abs(s-n)>1?{allowed:!1,message:`Cannot connect elements with depth difference > 1: ${e.text||e.type} (depth ${s}) → ${i.text||i.type} (depth ${n})`,ruleName:this.name}:{allowed:!0,ruleName:this.name}}getElementDepth(t){let e=0,i=t.parent;for(;i;)e++,i=i.parent;return e}}class it{constructor(){this.popup=null,this.createPopup()}createPopup(){this.popup=document.createElement("div"),this.popup.id="ruleFeedbackPopup",this.popup.className="rule-feedback-popup hidden",this.popup.innerHTML=`
      <div class="rule-feedback-content">
        <div class="rule-feedback-header">
          <span class="rule-feedback-title">Action Blocked</span>
          <button class="rule-feedback-close">&times;</button>
        </div>
        <div class="rule-feedback-body">
          <div class="rule-feedback-message"></div>
          <div class="rule-feedback-rule"></div>
        </div>
      </div>
    `;const t=document.createElement("style");t.textContent=`
      .rule-feedback-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #ffffff;
        border: 2px solid #e74c3c;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 300px;
        max-width: 500px;
      }

      .rule-feedback-popup.hidden {
        display: none;
      }

      .rule-feedback-content {
        padding: 0;
      }

      .rule-feedback-header {
        background: #e74c3c;
        color: white;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 6px 6px 0 0;
      }

      .rule-feedback-title {
        font-weight: bold;
        font-size: 16px;
      }

      .rule-feedback-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rule-feedback-close:hover {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .rule-feedback-body {
        padding: 16px;
      }

      .rule-feedback-message {
        margin-bottom: 12px;
        font-size: 14px;
        line-height: 1.4;
        color: #333;
      }

      .rule-feedback-rule {
        font-size: 12px;
        color: #666;
        font-style: italic;
      }

      .rule-feedback-rule::before {
        content: "Rule: ";
        font-weight: bold;
      }
    `,document.head.appendChild(t),document.body.appendChild(this.popup);const e=this.popup.querySelector(".rule-feedback-close");e==null||e.addEventListener("click",()=>this.hide()),this.popup.addEventListener("click",i=>{i.target===this.popup&&this.hide()}),document.addEventListener("keydown",i=>{var s;i.key==="Escape"&&!((s=this.popup)!=null&&s.classList.contains("hidden"))&&this.hide()})}show(t){if(!this.popup)return;const e=this.popup.querySelector(".rule-feedback-message"),i=this.popup.querySelector(".rule-feedback-rule");e&&(e.textContent=t.message||"Action not allowed"),i&&(i.textContent=t.ruleName),this.popup.classList.remove("hidden"),setTimeout(()=>{this.hide()},5e3)}hide(){this.popup&&this.popup.classList.add("hidden")}}class nt{constructor(t,e,i){this.inputState=t,this.appState=e,this.projectManager=new V(e),this.layout=new K(i),this.ruleEngine=new Z,this.ruleFeedback=new it}processInput(){let t=this.inputState.activeId,e=this.inputState.secondaryId;switch(this.inputState.isEditing||(this.appState.editingElement=void 0),this.inputState.getAction){case"layout":this.appState.autoLayout=!this.appState.autoLayout,this.appState.autoLayout?this.restartLayout():this.layout.stop();break;case"create":this.appState.contextMenu=!1,t=this.handleCreate(),this.tryRestartLayout();break;case"move":this.handleMove(),this.tryRestartLayout();break;case"connect":this.handleConnect(),t=this.inputState.activeId,e=void 0,this.tryRestartLayout();break;case"select":t=this.handleSelect(),this.tryRestartLayout();break;case"anchor":this.handleAnchor();break;case"delete":this.appState.contextMenu=!1,this.handleDelete(),this.tryRestartLayout(),t=void 0;break;case"edit":this.appState.contextMenu=!1,this.handleEdit();break;case"menu":this.appState.contextMenu=!0,this.appState.targetPosition=this.inputState.mousePosition;break;case"save":this.projectManager.saveProject();break;case"load":this.projectManager.loadProject(),this.tryRestartLayout();break;case"clear":this.appState.clear(),this.layout.stop();break;case"zoomIn":case"zoomOut":case"resetView":this.appState.zoom=this.inputState.zoom,this.appState.pan=this.inputState.pan;break;case"changeMode":this.appState.currentMode=this.inputState.currentMode;break}this.appState.selectedElement=t?this.appState.getElementById(t):void 0,this.appState.fromElement=e?this.appState.getElementById(e):void 0,this.inputState.activeId=t,this.inputState.secondaryId=e}handleCreate(){if(!this.inputState.mousePosition)return;const{x:t,y:e}=this.inputState.mousePosition,i=this.inputState.activeId,s=i?this.appState.getElementById(i)??void 0:void 0,n=new z(this.inputState.elementType,t,e,s),o=this.ruleEngine.evaluateElementCreation(n,this.appState),r=this.ruleEngine.getBlockingResult(o);if(r){this.ruleFeedback.show(r);return}return this.appState.addElement(n),this.inputState.activeId=n.id,n.id}handleMove(){if(this.inputState.secondaryId&&this.inputState.mousePosition){const t=this.appState.getElementById(this.inputState.secondaryId);t&&(t.x=this.inputState.mousePosition.x,t.y=this.inputState.mousePosition.y)}}handleConnect(){const t=this.appState.getElementById(this.inputState.secondaryId),e=this.appState.getElementById(this.inputState.activeId);if(this.appState.connections.some(r=>r.from.id===t.id&&r.to.id===e.id||r.from.id===e.id&&r.to.id===t.id)){this.ruleFeedback.show({allowed:!1,message:`Connection already exists between ${t.text||t.type} and ${e.text||e.type}`,ruleName:"Duplicate Connection"});return}const s=this.ruleEngine.evaluateConnection(t,e,this.appState),n=this.ruleEngine.getBlockingResult(s);if(n){this.ruleFeedback.show(n);return}const o=new _(t,e);this.appState.addConnection(o)}handleSelect(){return this.inputState.activeId}handleAnchor(){const t=this.appState.getElementById(this.inputState.activeId);t.isAnchored=!t.isAnchored}handleDelete(){const t=e=>{const i=this.appState.getElementById(e);i&&(i.children.forEach(s=>t(s.id)),this.appState.removeConnectionsFor(i.id),this.appState.removeElement(e))};this.inputState.activeId&&t(this.inputState.activeId)}handleEdit(){if(this.inputState.activeId){const t=this.appState.getElementById(this.inputState.activeId);this.appState.editingElement=t,this.inputState.text!==void 0&&t&&(t.text=this.inputState.text)}}restartLayout(){this.layout.stop();const t=this.inputState.secondaryId?[this.inputState.secondaryId]:[];this.layout.start(this.appState.getRootElements(),this.appState.connections,t)}tryRestartLayout(){this.appState.autoLayout&&this.restartLayout()}}class st{constructor(t){this.panelContainer=document.getElementById("editbar"),this.textInput=this._createInputField("Name"),this.idField=this._createReadOnlyProperty("ID"),this.typeField=this._createReadOnlyProperty("Type"),this.xField=this._createReadOnlyProperty("Pos X"),this.yField=this._createReadOnlyProperty("Pos Y"),this.updatePanel=e=>{if(!e){this.panelContainer.classList.add("hidden");return}this.panelContainer.classList.remove("hidden"),this.idField.textContent=e.id.toString(),this.typeField.textContent=e.type,this.textInput.value=e.text,this.xField.textContent=Math.round(e.x).toString(),this.yField.textContent=Math.round(e.y).toString()},this.appState=t}_createReadOnlyProperty(t){return this._createElement("readonlyPropTemplate","readonlyProps",".propValue",t)}_createInputField(t){const e=this._createElement("inputFieldTemplate","inputFields",".propInput",t);return e.name=t,e.autocomplete="off",e}_createElement(t,e,i,s){const n=document.getElementById(t).cloneNode(!0);return n.id="",n.querySelector(".propLabel").textContent=s,document.getElementById(e).appendChild(n),n.querySelector(i)}getInputs(){return[this.textInput]}}const ot=["collection","function","object","input","output"];class at{constructor(){this.elementTemplates=new Map,this.loadElementTemplates()}loadElementTemplates(){const t=document.getElementById("elementTemplates");if(!t)throw new Error("No template");Array.from(t.children).forEach(e=>{if(e instanceof HTMLElement&&e.classList.contains("template")){const i=ot.find(s=>e.classList.contains(s));if(!i)throw new Error("Undefined type");this.elementTemplates.set(i,e)}})}createDOMElement(t,e){const i=this.elementTemplates.get(t.type);if(!i)throw new Error("No template");const s=i.cloneNode(!0);return s.classList.remove("template"),s.dataset.id=t.id,e.appendChild(s),s}updateElement(t,e,i,s,n,o){t.style.left=e.x+i.x-e.width/2+"px",t.style.top=e.y+i.y-e.height/2+"px",t.style.width=e.width+"px",t.style.height=e.height+"px",t.style.setProperty("--stroke-width",e.strokeWidth+"px"),t.style.setProperty("--depth",e.depth.toString());const r=t.querySelector(".element-text"),a=t.querySelector(".element-input");if(!r||!a)throw new Error("No text/input");r.textContent=e.text,a.value=e.text,this.updateStateClass(t,"child",!!e.parent),this.updateStateClass(t,"parent",!!e.children.length),this.updateStateClass(t,"anchored",e.isAnchored),this.updateStateClass(t,"selected",s),this.updateStateClass(t,"secondary",n),this.updateEditingState(t,e,o)}updateStateClass(t,e,i){t.classList.toggle(e,i)}updateEditingState(t,e,i){const s=t.querySelector(".element-text"),n=t.querySelector(".element-input");!s||!n||(i?(s.style.display="none",n.style.display="block",n.focus(),n.value=e.text):(s.style.display="block",n.style.display="none",s.textContent=e.text))}}class rt{constructor(t,e){this.canvas=t,this.state=e,this.elementMap=new Map,this.connectionMap=new Map,this.propertiesPanel=new st(e),this.elementFactory=new at}render(){var t;this.updateStatus(),this.updateElementTypeSelection(),this.setCanvasTransform(this.state.zoom),this.renderElements(this.state.elements,((t=this.state.selectedElement)==null?void 0:t.id)??void 0),this.renderConnections(this.state.connections),this.propertiesPanel.updatePanel(this.state.selectedElement),this.state.rerenderNeeded=!1}renderElements(t,e){const i=new Set(t.map(n=>n.id));for(const[n,o]of this.elementMap)i.has(n)||(o.remove(),this.elementMap.delete(n));t.forEach(n=>{var r,a;let o=this.elementMap.get(n.id);o||(o=this.elementFactory.createDOMElement(n,this.canvas),this.elementMap.set(n.id,o)),this.elementFactory.updateElement(o,n,this.state.pan,n.id===e,((r=this.state.fromElement)==null?void 0:r.id)===n.id,((a=this.state.editingElement)==null?void 0:a.id)===n.id)});const s=this.state.targetPosition;this.state.contextMenu&&s?this.showContextMenu(s.x,s.y):this.hideContextMenu()}renderConnections(t){const e=new Set(t.map(i=>i.id));for(const[i,s]of this.connectionMap)e.has(i)||(s.remove(),this.connectionMap.delete(i));t.forEach(i=>{const s=i.from,n=i.to;if(!s||!n)return;let o=this.connectionMap.get(i.id);o||(o=this.createConnectionDOM(),this.connectionMap.set(i.id,o)),this.updateConnectionDOM(o,s,n)})}createConnectionDOM(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.classList.add("connection-svg");const e=document.createElementNS("http://www.w3.org/2000/svg","line");return e.classList.add("connection-line"),t.appendChild(e),this.canvas.appendChild(t),t}updateConnectionDOM(t,e,i){const s=t.querySelector("line");if(!s)return;const n=e.x,o=e.y,r=i.x,a=i.y,c=20,d=Math.min(n,r)-c,l=Math.min(o,a)-c,u=Math.max(n,r)+c,L=Math.max(o,a)+c;t.style.left=d+"px",t.style.top=l+"px",t.style.width=u-d+"px",t.style.height=L-l+"px";const A=n-d,f=o-l,F=r-d,R=a-l;s.setAttribute("x1",A.toString()),s.setAttribute("y1",f.toString()),s.setAttribute("x2",F.toString()),s.setAttribute("y2",R.toString())}showContextMenu(t,e){const i=document.getElementById("contextMenu"),s=this.canvas.getBoundingClientRect();if(i){let n=s.left+t,o=s.top+e;n+i.offsetWidth>window.innerWidth-20&&(n=window.innerWidth-i.offsetWidth-20),o+i.offsetHeight>window.innerHeight-20&&(o=window.innerHeight-i.offsetHeight-20),i.style.left=n+"px",i.style.top=o+"px",i.classList.remove("hidden")}}hideContextMenu(){const t=document.getElementById("contextMenu");t&&t.classList.add("hidden")}getActivePanelInputs(){return this.propertiesPanel.getInputs()}updateElementTypeSelection(){const t=document.getElementById("elementTypeSelection");this.state.currentMode==="create"?t.classList.remove("hidden"):t.classList.add("hidden")}updateStatus(){const t={create:"Create/Child Mode",connect:"Connection Mode",move:"Movement Mode",edit:"Edit Mode"},e={collection:"Collections",function:"Functions",object:"Objects",input:"Inputs",output:"Outputs"};let i=`${t[this.state.currentMode]}`;this.state.currentMode==="create"&&(i+=` - ${e[this.state.currentElementType]}`),this.state.currentMode==="connect"&&this.state.fromElement&&(i+=" - Select target element");const s=document.getElementById("status");s&&(s.textContent=i)}setCanvasTransform(t){const e=1/t;this.canvas.style.width=`${100*e}%`,this.canvas.style.height=`${100*e}%`,this.canvas.style.transform=`scale(${t})`,this.canvas.style.transformOrigin="0 0"}}class ct{constructor(t,e,i,s){this.canvas=t,this.inputState=e,this.getElementsCallback=i,this.getPanelInputsCallback=s,this.handleClick=n=>{const o=this.getElementsCallback(),{x:r,y:a}=this.getCanvasCoordinates(n),c=this.findElementAt(o,r,a);this.inputState.interpretClick(r,a,c==null?void 0:c.id,n.shiftKey)},this.handleMouseDown=n=>{const{x:o,y:r}=this.getCanvasCoordinates(n),a=this.findElementAt(this.getElementsCallback(),o,r);this.inputState.interpretMouseDown(o,r,a)},this.handleMouseUp=()=>{this.inputState.interpretMouseUp()},this.handleMouseMove=n=>{const{x:o,y:r}=this.getCanvasCoordinates(n);this.inputState.secondaryId&&this.inputState.currentMode==="move"&&(this.getElementsCallback().find(d=>d.id===this.inputState.secondaryId)&&this.inputState.dragOffset&&this.inputState.interpretDrag(this.inputState.secondaryId,o,r),n.preventDefault())},this.handleDoubleClick=n=>{const{x:o,y:r}=this.getCanvasCoordinates(n),a=this.getElementsCallback(),c=this.findElementAt(a,o,r);c&&this.inputState.interpretDoubleClick(o,r,c.id)},this.handleContextMenu=n=>{n.preventDefault();const{x:o,y:r}=this.getCanvasCoordinates(n),a=this.findElementAt(this.getElementsCallback(),o,r);this.inputState.interpretContextMenu(o,r,a==null?void 0:a.id)},this.handleContextMenuOption=(n,o)=>{n.preventDefault(),this.inputState.interpretContextMenuOption(o)},this.handleControlsAction=(n,o)=>{n.preventDefault(),this.inputState.interpretControlsAction(o)},this.handleDirectAction=(n,o)=>{n.preventDefault(),this.inputState.setAction(o)},this.handleInput=n=>{const o=n.target;if(!o||o.tagName!=="INPUT")return;const r=this.inputState.activeId;if(!r)return;const a=o.closest(".element");if((a==null?void 0:a.dataset.id)===r&&this.inputState.isEditing){this.inputState.interpretTextEdit(r,o.value);return}this.getPanelInputsCallback().includes(o)&&r&&this.inputState.interpretTextEdit(r,o.value)},this.handleKeyDown=n=>{const o=this.inputState.activeId;if(o)switch(n.code){case"F2":this.inputState.interpretTextEdit(o);return;case"Escape":this.inputState.interpretActionOnElement("select",void 0);break;case"KeyA":this.inputState.interpretActionOnElement("anchor",o);break}this.inputState.isEditing&&o&&(n.key==="Escape"||n.key==="Enter")&&(this.inputState.setAction("select"),n.preventDefault())},this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("click",this.handleClick),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("dblclick",this.handleDoubleClick),this.setupModeButtons(),this.setupElementTypeButtons(),this.setupContextMenuEvents(),this.setupProjectEvents(),this.setupControlsEvents(),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("input",this.handleInput)}setupControlsEvents(){const t=document.getElementById("layoutBtn"),e=document.getElementById("zoomInBtn"),i=document.getElementById("zoomOutBtn"),s=document.getElementById("resetViewBtn");t.addEventListener("click",n=>{this.handleControlsAction(n,"layout"),t.classList.toggle("active")}),e.addEventListener("click",n=>this.handleControlsAction(n,"zoomIn")),i.addEventListener("click",n=>this.handleControlsAction(n,"zoomOut")),s.addEventListener("click",n=>this.handleControlsAction(n,"resetView"))}setupProjectEvents(){const t=document.getElementById("saveBtn"),e=document.getElementById("loadBtn"),i=document.getElementById("clearBtn");t&&t.addEventListener("click",s=>this.handleDirectAction(s,"save")),e&&e.addEventListener("click",s=>this.handleDirectAction(s,"load")),i&&i.addEventListener("click",s=>this.handleDirectAction(s,"clear"))}setupModeButtons(){document.querySelectorAll(".mode-btn, [data-mode]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".mode-btn, [data-mode]").forEach(i=>i.classList.remove("active")),t.classList.add("active");const e=t.dataset.mode;e&&this.inputState.interpretModeChange(e)})})}setupElementTypeButtons(){document.querySelectorAll(".element-btn, [data-type]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".element-btn, [data-type]").forEach(i=>i.classList.remove("active")),t.classList.add("active");const e=t.dataset.type;e&&(this.inputState.elementType=e)})})}setupContextMenuEvents(){var t,e,i;(t=document.getElementById("editBtn"))==null||t.addEventListener("click",s=>this.handleContextMenuOption(s,"edit")),(e=document.getElementById("duplicateBtn"))==null||e.addEventListener("click",s=>this.handleContextMenuOption(s,"duplicate")),(i=document.getElementById("deleteBtn"))==null||i.addEventListener("click",s=>this.handleContextMenuOption(s,"delete")),this.canvas.addEventListener("contextmenu",this.handleContextMenu)}getCanvasCoordinates(t){const e=this.canvas.getBoundingClientRect(),i=this.inputState.zoom,s=this.inputState.pan,n=(t.clientX-e.left)/i-s.x,o=(t.clientY-e.top)/i-s.y;return{x:n,y:o}}resetConnectionState(){this.inputState.resetConnectionState()}findElementAt(t,e,i){for(let s=t.length-1;s>=0;s--){const n=t[s],o=n.x-n.width/2,r=n.x+n.width/2,a=n.y-n.height/2,c=n.y+n.height/2;if(e>=o&&e<=r&&i>=a&&i<=c)return n}}}class ht{constructor(){this.currentMode="create",this.currentElementType="object",this.elements=[],this.connections=[],this.zoom=1,this.pan={x:0,y:0},this.contextMenu=!1,this.rerenderNeeded=!1,this.autoLayout=!0}setMode(t){this.currentMode=t}setElementType(t){this.currentElementType=t}addElement(t){this.elements.push(t)}removeElement(t){const e=this.elements.findIndex(i=>i.id===t);e!==-1&&this.elements.splice(e,1)}addConnection(t){this.connections.push(t)}removeConnection(t){const e=this.connections.findIndex(i=>i.id===t);e!==-1&&this.connections.splice(e,1)}removeConnectionsFor(t){this.connections=this.connections.filter(e=>e.from.id!==t&&e.to.id!==t)}getElementById(t){return this.elements.find(e=>e.id===t)}getRootElements(t){return this.elements.filter(e=>!e.parent&&((t==null?void 0:t(e))??!0))}selectElement(t){this.selectedElement=t}hasConnection(t,e){return this.connections.some(i=>i.from.id===t&&i.to.id===e||i.from.id===e&&i.to.id===t)}serialize(){return JSON.stringify({elements:this.elements.map(t=>t.serialize()),connections:this.connections.map(t=>t.serialize())})}deserialize(t){const e=JSON.parse(t);this.clear();const i=new Map,s=new Map;this.elements=e.elements.map(n=>{const o=new z(n.type,n.x,n.y);return o.id=n.id,o.text=n.text,i.set(o.id,o),n.parentId&&s.set(o.id,n.parentId),o});for(const[n,o]of s){const r=i.get(n),a=i.get(o);r&&a&&(r.parent=a,a.children.includes(r)||(a.children.push(r),a.calculateSize()))}this.connections=e.connections.map(n=>{const o=this.getElementById(n.from),r=this.getElementById(n.to);if(!o||!r)throw new Error(`Invalid connection: missing element (from: ${n.from}, to: ${n.to})`);const a=new _(o,r);return a.id=n.id,a})}clear(){this.elements=[],this.connections=[],this.selectedElement=void 0,this.fromElement=void 0,this.zoom=1,this.pan={x:0,y:0},this.editingElement=void 0,this.contextMenu=!1,this.targetPosition=void 0}}class dt{constructor(t){this.appState=new ht,this.inputState=new W,this.logicLayer=new nt(this.inputState,this.appState,t),this.renderLayer=new rt(t,this.appState),this.inputLayer=new ct(t,this.inputState,()=>this.appState.elements,()=>this.renderLayer.getActivePanelInputs()),this.start()}start(){const t=()=>{try{(this.inputState.getAction!=="none"||this.appState.rerenderNeeded||this.appState.autoLayout)&&(this.logicLayer.processInput(),this.renderLayer.render(),this.inputState.clear())}catch(e){console.error("Error in update cycle:",e)}requestAnimationFrame(t)};requestAnimationFrame(t)}save(){return this.appState.serialize()}load(t){try{this.appState.deserialize(t),this.renderLayer.render()}catch(e){console.error("Failed to load data:",e)}}exportModel(){return this.appState.serialize()}importModel(t){this.appState.deserialize(JSON.stringify(t)),this.renderLayer.render()}}const N={selected:"var(--color-yellow)",child:"var(--color-orange)",parent:"var(--color-green)",anchored:"var(--color-purple)",secondary:"var(--color-blue)"};function lt(h){if(h.length===0)return"radial-gradient(circle, rgba(156, 163, 175, 0.3) 0%, transparent 100%)";if(h.length===1)return`radial-gradient(circle, ${N[h[0]]} 0%, transparent 100%)`;const t=360/h.length;return`conic-gradient(${h.map((i,s)=>{const n=s*t,o=(s+1)*t;return`${N[i]} ${n}deg ${o}deg`}).join(", ")})`}function D(h){const t=[];Object.keys(N).forEach(i=>{h.classList.contains(i)&&t.push(i)});const e=lt(t);h.style.setProperty("--element-gradient",e)}function ut(){const h=new MutationObserver(e=>{e.forEach(i=>{if(i.type==="attributes"&&i.attributeName==="class"){const s=i.target;s.classList.contains("element")&&D(s)}})});document.querySelectorAll(".element").forEach(e=>{h.observe(e,{attributes:!0,attributeFilter:["class"]}),D(e)}),new MutationObserver(e=>{e.forEach(i=>{i.addedNodes.forEach(s=>{s instanceof HTMLElement&&s.classList.contains("element")&&(h.observe(s,{attributes:!0,attributeFilter:["class"]}),D(s))})})}).observe(document.body,{childList:!0,subtree:!0})}document.addEventListener("DOMContentLoaded",()=>{try{const h=document.getElementById("canvas"),t=new dt(h);window.app=t}catch(h){console.error("Failed to initialize application:",h)}});ut();
